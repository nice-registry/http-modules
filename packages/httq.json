{"name":"httq","version":"0.8.3","description":"Middleware for bridging HTTP and AMQP","main":"index.js","repository":"https://github.com/guidesmiths/httq","scripts":{"up":"docker-compose up","test":"AWS_PROFILE=guidesmiths mocha --recursive tests"},"keywords":["http","amqp","bridge"],"license":"ISC","homepage":"https://github.com/guidesmiths/httq","dependencies":{"aws-sdk":"^2.1.23","debug":"^2.1.3","express":"^4.12.3","hogan.js":"^3.0.2","lodash":"^3.6.0","request":"^2.55.0","safe-json-parse":"^4.0.0","tv4":"^1.1.9","tv4-formats":"^1.0.0"},"devDependencies":{"async":"^0.9.0","body-parser":"^1.12.2","express":"^4.12.3","mocha":"^2.2.1","rascal":"^0.7.2","request":"^2.55.0"},"gitHead":"e28a3334003da60fbd25f5b7132847c9e999deba","versions":[{"number":"0.1.0","date":"2015-04-03T17:53:02.723Z"},{"number":"0.1.1","date":"2015-04-03T18:03:21.711Z"},{"number":"0.1.2","date":"2015-04-03T18:19:30.786Z"},{"number":"0.1.3","date":"2015-04-04T22:44:53.446Z"},{"number":"0.2.0","date":"2015-04-06T09:54:03.956Z"},{"number":"0.2.1","date":"2015-04-06T19:56:52.888Z"},{"number":"0.3.0","date":"2015-04-08T23:31:07.283Z"},{"number":"0.3.1","date":"2015-04-09T08:22:50.869Z"},{"number":"0.3.2","date":"2015-04-11T16:50:32.892Z"},{"number":"0.3.3","date":"2015-04-11T17:19:10.999Z"},{"number":"0.3.4","date":"2015-04-11T17:27:33.127Z"},{"number":"0.3.5","date":"2015-04-12T19:08:54.485Z"},{"number":"0.4.0","date":"2015-04-13T08:11:32.962Z"},{"number":"0.5.0","date":"2015-04-14T08:41:01.508Z"},{"number":"0.5.1","date":"2015-04-14T09:57:42.395Z"},{"number":"0.6.0","date":"2015-04-18T07:44:31.257Z"},{"number":"0.7.1","date":"2015-04-27T22:57:46.177Z"},{"number":"0.7.2","date":"2015-04-28T17:01:48.002Z"},{"number":"0.7.4","date":"2015-05-19T11:53:45.956Z"},{"number":"0.8.0","date":"2015-05-19T12:45:43.218Z"},{"number":"0.8.1","date":"2015-05-19T23:11:04.954Z"},{"number":"0.8.2","date":"2015-05-19T23:37:57.485Z"},{"number":"0.8.3","date":"2015-05-20T07:21:17.871Z"}],"readme":"# httq\nMiddleware for bridging HTTP and AMQP\n\n## Installation\n```js\nnpm install httq\n```\n\n## Prequisits\n* RabbitMQ\n* Familiarity with [Rascal](https://github.com/guidesmiths/rascal)\n\n## Usage\n\n### Step 1 - Plug httq into an express app\n```js\nvar httq = require('httq')\nvar async = require('async')\nvar rascal = require('rascal')\nvar express = require('express')\nvar bodyParser = require('body-parser')\nvar config = require('./config.json')\n\nvar rascalConfig = rascal.withDefaultConfig(config.rascal)\n\nrascal.createBroker(rascalConfig, function(err, broker) {\n\n    if (err) bail(err)\n\n    var app = express()\n    app.use(bodyParser.json())\n    httq.init(broker, config.httq.book_loan_v1, function(err, httqs) {\n        if (err) bail(err)\n        app.post('/api/library/v1/books/:isbn/loans', httqs.book_loan_v1)\n        app.listen(3000)\n    })\n\n    console.log('Try: curl -H \"Content-Type: application/json\" -X POST http://localhost:3000/api/library/v1/books/978-0132350884/loans -d \\'{\"member\": \"6545345\"}\\'')\n\n    function bail(err) {\n        console.error(err.message)\n        process.exit(1)\n    }\n})\n```\n\n### Step 2 - Configure httq and rascal\n```json\n{\n    \"httq\": {\n        \"routes\": {\n            \"book_loan_v1\": {\n                \"methods\": [\"post\"],\n                \"pattern\": \"/api/library/v1/books/:isbn/loans\",\n                \"sequence\": [\"requestToTemplateVars\", \"requestPathToRoutingKey\", \"requestToMessage\", \"fireAndForget\"],\n                \"warez\": {\n                    \"requestPathToRoutingKey\": {\n                        \"options\": {\n                            \"method\": {\n                                \"suffix\": true,\n                                \"mapping\": {\n                                    \"POST\": \"created\"\n                                }\n                            }\n                        }\n                    },\n                    \"fireAndForget\": {\n                        \"options\": {\n                            \"publication\": \"p1\"\n                        }\n                    }\n                }\n            }\n        }\n    },\n    \"rascal\": {\n        \"vhosts\": {\n            \"/\": {\n                \"namespace\": true,\n                \"exchanges\": {\n                    \"e1\": {}\n                },\n                \"queues\": {\n                    \"q1\": {}\n                },\n                \"bindings\": {\n                    \"b1\": {\n                        \"source\": \"e1\",\n                        \"destination\": \"q1\",\n                        \"bindingKey\": \"api.library.v1.#.loans.created\"\n                    }\n                }\n            }\n        },\n        \"publications\": {\n            \"p1\": {\n                \"exchange\": \"e1\"\n            }\n        },\n        \"subscriptions\": {\n            \"s1\": {\n                \"queue\": \"q1\"\n            }\n        }\n    }\n}\n```\n### Step 3 - Start the app and send it an HTTP request\n```json\n$ node server.js &\n$ curl -H \"Content-Type: application/json\" -X POST -d '{\"member\":\"6545345\"}' http://localhost:3000/api/library/v1/books/978-0132350884/loans\n{\"txid\":\"c09f94a4-f152-46d5-8266-39505bb446a1\"}\n```\n### Step 4 - Check your broker for the message.\nIt should look something like this:\n```json\n{\n  \"fields\": {\n    \"consumerTag\": \"amq.ctag-Nw13m2-6DntZKTS1PhK5gg\",\n    \"deliveryTag\": 1,\n    \"redelivered\": false,\n    \"exchange\": \"e1\",\n    \"routingKey\": \"api.library.v1.books.978-0132350884.loans.created\"\n  },\n  \"properties\": {\n    \"contentType\": \"application/json\",\n    \"headers\": {\n      \"httq\": {\n        \"method\": \"POST\",\n        \"url\": \"/api/library/v1/books/978-0132350884/loans\",\n        \"query\": {},\n        \"headers\": {\n          \"user-agent\": \"curl/7.30.0\",\n          \"host\": \"localhost:3000\",\n          \"accept\": \"*/*\",\n          \"content-type\": \"application/json\",\n          \"content-length\": \"20\"\n        },\n        \"params\": {\n          \"isbn\": \"978-0132350884\"\n        }\n      }\n    },\n    \"deliveryMode\": 2,\n    \"messageId\": \"c09f94a4-f152-46d5-8266-39505bb446a1\"\n  },\n  \"content\": {\n    \"member\": \"6545345\"\n  }\n}\n```\n\n## Middleware\nhttq middleware needs to be initialised for each route in your express application, by passing httq.init with a broker, configuration, ctx (optional), and callback. The init method will build a chain of middleware in the order defined by the sequence attribute. If you need to pass paramters to a specific middleware then specifiy it in the warez block.\n\n```json\n{\n    \"sequence\": [\"requestToTemplateVars\", \"requestPathToRoutingKey\", \"requestToMessage\", \"fireAndForget\"],\n    \"warez\": {\n        \"requestPathToRoutingKey\": {\n            \"options\": {\n                \"method\": {\n                    \"suffix\": true,\n                    \"mapping\": {\n                        \"POST\": \"created\"\n                    }\n                }\n            }\n        },\n        \"fireAndForget\": {\n            \"options\": {\n                \"publication\": \"p1\"\n            }\n        }\n    }\n}\n```\nEach middleware in the chain should export a single function that expects the config, context and callback. It should return the a function with typical express middleware signature. If you want a middleware to appear twice just relist it in the sequence. If you want the two instances to have different parameters, give it a unique name and specify the 'type' parameter.\n\n```json\n{\n    \"sequence\": [\"logStart\", \"logEnd\"],\n    \"warez\": {\n        \"logStart\": {\n            \"type\": \"logger\",\n            \"options\": {\n                \"message\": \"start\"\n            }\n        },\n        \"logEnd\": {\n            \"type\": \"logger\",\n            \"options\": {\n                \"message\": \"end\"\n            }\n        }\n    }\n}\n```\n\n\n```js\nmodule.exports = function(config, ctx, next) {\n    // ...\n    next(null, function(req, res, next) {\n        // ...\n    })\n}\n```\n\n### Provided Middleware\n\n#### requestToTemplateVars\nExtracts variables from the request and stores them in req.httq.templateVars, e.g.\n```js\n{\n    templateVars: {\n        method: \"POST\",\n        url: \"/api/library/v1/books/978-0132350884/loans\",\n        params: {\n            isbn: \"978-0132350884\"\n        },\n        headers: {\n            user-agent: \"curl/7.30.0\",\n            host: \"localhost:3000\",\n            accept: \"*/*\",\n            content-type: \"application/json\",\n            content-length: \"20\"\n        }\n        query: {\n        }\n    }\n}\nThese are typically usd when generating the routing key and message published to your AMQP broker.\n\n#### requestToRoutingKey\nGenerates a routing key from the request by passing the templateVars through a hogan template. The routing key is stored in req.httq.message.routingKey\n```json\n{\n    \"requestToRoutingKey\": {\n        \"options\": {\n            \"template\": \"library.v2.books.loans.{{request.method}}\"\n        }\n    }\n}\n```\nYou can map the request method to something more meaningful\n```js\n{\n    \"requestToRoutingKey\": {\n        \"options\": {\n            \"template\": \"library.v2.books.loans.{{request.method}}\"\n            \"method\": {\n                \"mapping\": {\n                    \"POST\": \"created\"\n                }\n            }\n        }\n    }\n}\n```\n\n#### requestPathToRoutingKey\nGenerates a routing key from the request by replacing slashes with full stops. The routing key is stored in req.httq.message.routingKey. No parameters are required but you may optionall include the request method.\n```json\n{\n    \"requestPathToRoutingKey\": {\n        \"options\": {\n            \"method\": {\n                \"prefix\": true,\n                \"mapping\": {\n                    \"POST\": \"created\"\n                }\n            }\n        }\n    }\n}\n```\n\n#### requestToMessage\nGenerates AMQP message headers and content from the request. This is stored in req.httq.message.headers and req.httq.message.content. You can see an example of the generated message in step 4.\n\n#### requestToMessageContent\nGenerates AMQP message content from the request. A json document reprsenting the full request (url, params, headers, query parameters and body) is stored in req.httq.message.content\n\n#### requestToSchemaUrl\nGenerates a schema url from the request by passing the templateVars through a hogan template. The routing key is stored in req.httq.message.schema\n\n#### httpSourcedJsonValidator\nValidates the message against a JSON schema downloaded using http. The validator uses [tv4](https://github.com/geraintluff/tv4) and [tv4-formats](https://github.com/ikr/tv4-formats). The schema url must be set it req.httq.message.schema and will be downloaded and cached (along with any referenced schemas) in during the request flow. If a schema cannot be downloaded the middleware responds with 500. If validation succeeds the message will be decorated with an httq header giving the uri of the schema that the message was validated against. If validation fails, httq will respond with 400 'Bad Request' and a json document describing the errors, e.g.\n```json\n[\n    {\n        \"message\": \"Missing required property: id\",\n        \"params\": {\n            \"key\": \"id\"\n        },\n        \"code\": 302,\n        \"dataPath\": \"\",\n        \"schemaPath\": \"/required/0\",\n        \"subErrors\": null,\n        \"name\": \"ValidationError\"\n    },\n    {\n        \"message\": \"Missing required property: type\",\n        \"params\": {\n            \"key\": \"type\"\n        },\n        \"code\": 302,\n        \"dataPath\": \"\",\n        \"schemaPath\": \"/required/1\",\n        \"subErrors\": null,\n        \"name\": \"ValidationError\"\n    }\n]\n```\n\n####s3SourcedJsonValidator\nValidates the message against a JSON schema from S3. The validator uses [tv4](https://github.com/geraintluff/tv4) and [tv4-formats](https://github.com/ikr/tv4-formats). The schema url must be set it req.httq.message.schema and will be downloaded and cached (along with any referenced schemas) in during the request flow. If a schema cannot be downloaded the middleware responds with 500. If validation succeeds the message will be decorated with an httq header giving the uri of the schema that the message was validated against. If validation fails, httq will respond with 400 'Bad Request' and a json document describing the errors as specified above.\n\nThe s3SourcedJsonValidator requires the following configuration\n```json\n{\n    \"s3\": {\n        \"bucket\": \"s3-bucket-name\",\n        \"region\": \"aws-region\"\n    }\n}\n```\n\n#### filesystemSourcedJsonValidator\nValidates the message against a JSON schema from the file system. The validator uses [tv4](https://github.com/geraintluff/tv4) and [tv4-formats](https://github.com/ikr/tv4-formats). The schema url must be set it req.httq.message.schema and will be loaded and cached (along with any referenced schemas) in during the request flow. If a schema cannot be read the middleware responds with 500. If validation succeeds the message will be decorated with an httq header giving the uri of the schema that the message was validated against. If validation fails, httq will respond with 400 'Bad Request' and a json document describing the errors as specified above.\n\n#### fireAndForget\nPublishes the AMQP message to a Rascal publication using the routing key defined in the context. If successful the middleware will return 202 \"Accepted\" and a transaction id corresponding to the message id\n```json\n{\"txid\":\"c09f94a4-f152-46d5-8266-39505bb446a1\"}\n```\n\n### Custom Middlware\nYou can override the httq middleware or add your own by initialising the ctx \"warez\" attribute, e.g.\n\n```js\nvar customFireAndForget = require('./lib/customFireAndForget')\nvar extraMiddleware = require('./lib/extraMiddleware')\n\nhttq.init(broker, config.httq.book_loan_v1, {\n    warez: {\n        fireAndForget: customFireAndForget,\n        extraMiddleware: extraMiddleware\n    }\n}, function(err, httqs) {\n    //...\n})\n```\n\n\n\n\n","created":"2015-04-03T17:53:02.723Z","modified":"2015-05-20T07:21:17.871Z","lastPublisher":{"name":"guidesmiths","email":"stephen.cresswell@guidesmiths.com"},"owners":[{"name":"guidesmiths","email":"stephen.cresswell@guidesmiths.com"}],"other":{"_attachments":{},"_from":".","_id":"httq","_npmUser":{"name":"guidesmiths","email":"stephen.cresswell@guidesmiths.com"},"_npmVersion":"1.4.28","_rev":"1-1dc642802e7a638da0086f8ad7b31a5f","_shasum":"00687cda7b3959f62ec4476682eec29f04b51358","author":{"name":"Stephen Cresswell"},"bugs":{"url":"https://github.com/guidesmiths/httq/issues"},"directories":{},"dist-tags":{"latest":"0.8.3"},"dist":{"shasum":"00687cda7b3959f62ec4476682eec29f04b51358","tarball":"http://registry.npmjs.org/httq/-/httq-0.8.3.tgz"},"maintainers":[{"name":"guidesmiths","email":"stephen.cresswell@guidesmiths.com"}],"readmeFilename":"README.md","time":{"modified":"2015-05-20T07:21:17.871Z","created":"2015-04-03T17:53:02.723Z","0.1.0":"2015-04-03T17:53:02.723Z","0.1.1":"2015-04-03T18:03:21.711Z","0.1.2":"2015-04-03T18:19:30.786Z","0.1.3":"2015-04-04T22:44:53.446Z","0.2.0":"2015-04-06T09:54:03.956Z","0.2.1":"2015-04-06T19:56:52.888Z","0.3.0":"2015-04-08T23:31:07.283Z","0.3.1":"2015-04-09T08:22:50.869Z","0.3.2":"2015-04-11T16:50:32.892Z","0.3.3":"2015-04-11T17:19:10.999Z","0.3.4":"2015-04-11T17:27:33.127Z","0.3.5":"2015-04-12T19:08:54.485Z","0.4.0":"2015-04-13T08:11:32.962Z","0.5.0":"2015-04-14T08:41:01.508Z","0.5.1":"2015-04-14T09:57:42.395Z","0.6.0":"2015-04-18T07:44:31.257Z","0.7.1":"2015-04-27T22:57:46.177Z","0.7.2":"2015-04-28T17:01:48.002Z","0.7.4":"2015-05-19T11:53:45.956Z","0.8.0":"2015-05-19T12:45:43.218Z","0.8.1":"2015-05-19T23:11:04.954Z","0.8.2":"2015-05-19T23:37:57.485Z","0.8.3":"2015-05-20T07:21:17.871Z"}}}