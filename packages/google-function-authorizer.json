{"name":"google-function-authorizer","version":"0.1.0","description":"User management and authentication library for Google HTTP Functions","keywords":["google cloud","google cloud platform","google cloud functions","google datastore","user management","authentication","authenticator","authorization","authorizer","serverless"],"main":"index.js","scripts":{"test":"eslint lib/** && nyc mocha","report":"npm install -g codeclimate-test-reporter && codeclimate-test-reporter < coverage/lcov.info"},"repository":"https://github.com/pauloddr/google-function-authorizer","license":"MIT","homepage":"https://github.com/pauloddr/google-function-authorizer#readme","dependencies":{"@google-cloud/datastore":"1.0.1","bcrypt":"1.0.2","client-sessions":"0.8.0","gstore-node":"1.2.0"},"devDependencies":{"body-parser":"1.17.1","chai":"3.5.0","chai-http":"3.0.0","dotenv":"4.0.0","eslint":"3.19.0","express":"4.15.2","mocha":"3.3.0","nyc":"10.3.0"},"nyc":{"include":["index.js","lib/**/*.js"],"reporter":["lcov","text-summary","html"]},"gitHead":"b07e5c9cdaab09bbfc6af0bac4f556ec58d68ddb","versions":[{"number":"0.1.0","date":"2017-05-14T18:14:56.384Z"}],"readme":"# google-function-authorizer\n\n[![Build Status](https://semaphoreci.com/api/v1/pauloddr/google-function-authorizer/branches/master/shields_badge.svg)](https://semaphoreci.com/pauloddr/google-function-authorizer)\n[![Test Coverage](https://lima.codeclimate.com/github/pauloddr/google-function-authorizer/badges/coverage.svg)](https://lima.codeclimate.com/github/pauloddr/google-function-authorizer/coverage)\n[![Code Climate](https://lima.codeclimate.com/github/pauloddr/google-function-authorizer/badges/gpa.svg)](https://lima.codeclimate.com/github/pauloddr/google-function-authorizer)\n\nA simple user authentication and management system for [Google Cloud HTTP Functions](https://cloud.google.com/functions/docs/writing/http).\n\nIt stores user data in [Google Datastore](https://cloud.google.com/datastore/) using [gstore-node](https://github.com/sebelga/gstore-node); hashes passwords with [bcrypt](https://github.com/kelektiv/node.bcrypt.js); and manages browser sessions with [client-session](https://github.com/mozilla/node-client-sessions).\n\n## Usage\n\nCreate a new Google HTTP Function with the following code:\n\n```javascript\nconst users = require('google-function-authorizer')({\n  session: {secret: 'MYSECRETKEY'} // required!\n});\n\nexports.handleRequest = function (req, res) {\n  users.handle(req, res);\n};\n```\n\nAdd the library to __package.json__:\n\n```json\n{\n  \"name\": \"your-function\",\n  \"version\": \"0.0.1\",\n  \"dependencies\": {\n    \"google-function-authorizer\": \"0.1.0\"\n  }\n}\n```\n\nFinally, make sure the __entry point__ is correct. In the example above, it should be `handleRequest`.\n\nThen, assuming you named your function \"users\", the following endpoints will be served by your function:\n\n* `POST /users`\n* `POST /users/signin`\n* `POST /users/signout`\n* `GET /users`\n* `GET /users/:id`\n* `PUT|PATCH /users/:id`\n* `DELETE /users/:id`\n* `DELETE /users/signin`\n* `OPTIONS /users(/*)`\n\nRead more about how each endpoint works in the next section.\n\n## Actions\n\nAll actions respond with a JSON object with a `code` attribute with the following possible string values:\n\n* `OK` - action has completed successfully\n* `BAD_REQUEST` - action has failed due to request not being in expected format\n* `NOT_FOUND` - endpoint not found, or user not found\n* `UNAUTHORIZED` - action requires that a user signs in first\n* `FORBIDDEN` - action requires that signed-in user has permission to perform it\n* `INTERNAL_ERROR` - an unexpected error has occurred while performing the action\n\n### Create User\n\n* `POST /users`\n\nThis endpoint creates a new user.\n\n<table>\n<tr><th>Request Body</th><th>Response</th></tr>\n<tr><td>\n\n```javascript\n{\n  \"username\": \"MyUsername\",\n  \"email\": \"myemail@test.com\",\n  \"password\": \"abc123\"\n}\n```\n\n</td><td>\n\n```javascript\n{\n  \"code\": \"OK\",\n  \"user\": {\n    \"id\": \"12345\",\n    \"username\": \"MyUsername\",\n    \"email\": \"myemail@test.com\"\n  }\n}\n```\n\n</td></tr>\n</table>\n\n### Sign User In\n\n* `POST /users/signin`\n\nSigns a user in, starting a new session.\n\nThis endpoint sets a session cookie upon successful response, which will be sent in the next requests.\n\n<table>\n<tr><th>Request Body</th><th>Response</th></tr>\n<tr><td>\n\n```javascript\n{\n  \"email\": \"myemail@test.com\",\n  \"password\": \"abc123\"\n}\n```\n\n</td><td>\n\n```javascript\n{\n  \"code\": \"OK\",\n  \"user\": {\n    \"id\": \"12345\",\n    \"username\": \"MyUsername\",\n    \"email\": \"myemail@test.com\"\n  }\n}\n```\n\n</td></tr>\n</table>\n\n### Sign User Out\n\n* `POST /users/signout`\n* `DELETE /users/signin` (alternatively)\n\nSigns a user out, removing the session cookie.\n\n<table>\n<tr><th>Request Body</th><th>Response</th></tr>\n<tr><td>(empty)</td><td>\n\n```javascript\n{\n  \"code\": \"OK\"\n}\n```\n\n</td></tr>\n</table>\n\n### List Users\n\n* `GET /users`\n\nReturns a list of users with pagination. Default page size is 20.\n\nBy default, this endpoint requires the signed-in user role to be `admin`.\n\n<table>\n<tr><th>Request Query Parameters</th><th>Response</th></tr>\n<tr><td>\n\n* `/users`\n  * first 20 users\n* `/users?limit=10`\n  * first 10 users\n* `/users?start=NextPageKey000123`\n  * first 20 users\n  * starting from key \"NextPageKey000123\"\n\n</td><td>\n\n```javascript\n{\n  \"code\": \"OK\",\n  \"items\": [\n    {\"id\": \"1\", \"username\": \"user1\", \"email\": \"email1@test.com\", ...},\n    {\"id\": \"2\", \"username\": \"user2\", \"email\": \"email2@test.com\", ...},\n    ...\n  ],\n  \"limit\": 20,\n  \"next\": \"NextPageKey000123\"\n}\n```\n\n</td></tr>\n</table>\n\nThe `next` attribute will be absent from the response if there are no more entries to fetch.\n\n(Filters and sorting are not yet supported.)\n\n### Show User\n\n* `GET /users/:id`\n\nReturns data of a single user.\n\nBy default, this endpoint has the following requirements:\n\n* user ID being requested matches with signed-in user ID; or\n* the signed-in user role is `admin`.\n\n<table>\n<tr><th>Request URI</th><th>Response</th></tr>\n<tr><td>\n\n* `/users/12345`\n  * shows info of user ID=12345\n\n</td><td>\n\n```javascript\n{\n  \"code\": \"OK\",\n  \"user\": {\n    \"id\": \"12345\",\n    \"username\": \"MyUsername\",\n    \"email\": \"myemail@test.com\"\n  }\n}\n```\n\n</td></tr>\n</table>\n\n### Update User\n\n* `PUT /users/:id`\n* `PATCH /users/:id`\n\nUpdates data of a single user, including password.\n\nBoth `PUT` and `PATCH` methods behave the same way, and partial data can be provided.\n\nBy default, this endpoint has the following requirements:\n\n* user ID being updated matches with signed-in user ID; or\n* the signed-in user role is `admin`.\n\n(Not yet implemented) The user `role` attribute can only be updated by other admins.\n\n<table>\n<tr><th>Request Body</th><th>Response</th></tr>\n<tr><td>\n\n```javascript\n{\n  \"username\": \"EditedUsername\"\n}\n```\n\n</td><td>\n\n```javascript\n{\n  \"code\": \"OK\",\n  \"user\": {\n    \"id\": \"12345\",\n    \"username\": \"EditedUsername\",\n    \"email\": \"myemail@test.com\"\n  }\n}\n```\n\n</td></tr>\n</table>\n\n### Destroy User\n\n* `DELETE /users/:id`\n\nRemoves a user.\n\nBy default, this endpoint has the following requirements:\n\n* user ID being deleted matches with signed-in user ID; or\n* the signed-in user role is `admin`.\n\nIf user being deleted matches the user currently signed in, the user will be automatically signed out.\n\n<table>\n<tr><th>Request Body</th><th>Response</th></tr>\n<tr><td>(empty)</td><td>\n\n```javascript\n{\n  \"code\": \"OK\"\n}\n```\n\n</td></tr>\n</table>\n\n### Preflight Requests / Current Signed-in User\n\n* `OPTIONS /users`\n\nSome clients will fire a \"preflight request\" prior to making the real request to verify CORS options, which are supported by this library.\n\nYou can also use this method to retrieve the current signed-in user, which will be present in the response body, as well as the current endpoint rules (see Configuration for details), which the client can then use to prevent certain actions on their side.\n\n<table>\n<tr><th>Request Body</th><th>Response</th></tr>\n<tr><td>(empty)</td><td>\n\n```javascript\n{\n  \"code\": \"OK\",\n  \"userId\": \"12345\",\n  \"rules\": {\n    \"signin\": \"all\",\n    \"create\": \"all\",\n    \"update\": \"self\",\n    \"find\": \"self\",\n    \"list\": \"admin\",\n    \"destroy\": \"self\"\n  }\n}\n```\n\n</td></tr>\n</table>\n\n## Authorization\n\nCall `authorize` in your _other_ Google Functions to have the session cookie read from the request before calling your code:\n\n```javascript\nconst users = require('google-function-authorizer')({\n  session: {secret: 'MYSECRETKEY'} // required! must be the same as your users endpoint!\n});\n\nexports.handleRequest = function (req, res) {\n  users.authorize(req, res, mainFunction);\n};\n\nfunction mainFunction (req, res, user) {\n  // session is valid -- execute the rest of your function\n}\n```\n\nIf the session is valid, a `user` object will be passed along to your main function, containing a subset of stored attributes.\n\nIf the session is invalid, a `401 - Unauthorized` error will be returned automatically. If you want to take control of error processing, pass a fourth argument to `authorize` with an error function that takes `req` and `res` arguments.\n\n## Roles\n\nThis library comes with a very simple role management system built-in.\n\nThe default rules are:\n\n* Anyone can create a user or sign in.\n* Users with `admin` role are able to edit and delete other users.\n* Users with any other role are only allowed to edit or delete themselves.\n* Only admins can list users.\n* Users cannot be created with a role, since that specific endpoint is public.\n  * Another admin must edit newly created users if they need defined roles.\n\nThese rules are customizable. Refer to the next section to learn how to change them.\n\n## Configuration\n\nSettings can be customized upon requiring the library, and have the following defaults:\n\n```javascript\nconst users = require('google-function-authorizer')({\n\n  // Configure session cookie behavior here.\n  session: {\n    name: 'userSession', // cookie name\n    secret: null, // must be set! will raise error (and crash) if not defined\n    duration: 24 * 60 * 60 * 1000, // session expiration in ms\n    activeDuration: 1000 * 60 * 5 // session active duration in ms\n  },\n\n  // Datastore settings.\n  datastore: {\n    kind: 'User',\n    namespace: undefined\n  },\n\n  // You can overwrite the full schema, but it needs at least:\n  // - the primary field, and\n  // - the password field.\n  // Both field names can be defined in the \"fields\" section.\n  // If your schema is missing \"confirmation\" fields,\n  //   confirmation workflows will not run.\n  schema:  {\n    username: {\n      type: 'string',\n      optional: true,\n      excludeFromIndexes: true\n    },\n    email: {\n      type: 'string',\n      required: true,\n      validate: 'isEmail'\n    },\n    password: {\n      type: 'string',\n      required: true,\n      read: false,\n      excludeFromIndexes: true\n    },\n    role: {\n      type: 'string',\n      write: false\n    },\n    confirmationToken: {\n      type: 'string',\n      read: false\n    },\n    confirmedOn: {\n      type: 'datetime',\n      excludeFromIndexes: true\n    },\n    createdOn: {\n      type: 'datetime',\n      write: false,\n      default: Gstore.defaultValues.NOW,\n      excludeFromIndexes: true\n    },\n    modifiedOn: {\n      type: 'datetime',\n      write: false,\n      excludeFromIndexes: true\n    }\n  },\n\n  // If you use a custom schema, you can have custom field names as well.\n  fields: {\n    primary: 'email', // will be used in signin with password\n    username: 'username',\n    email: 'email',\n    password: 'password',\n    role: 'role'\n  },\n\n  // Customize CORS headers here to anything you'd like.\n  // Multiple headers are accepted.\n  cors: {\n    \"Access-Control-Allow-Origin\": \"*\"\n  },\n\n  // Apply rules for certain user-related actions.\n  // The following values are accepted:\n  // - \"all\": public and unrestricted access\n  // - \"user\": access for logged-in users only\n  // - \"self\": access for record owner only, or admins\n  // - \"admin\": admin access only\n  // - false: endpoint is disabled\n  //   (useful if you want to disable user creation, for example)\n  // Absence of field or value will default to \"admin\".\n  rules: {\n    signin: 'all',\n    create: 'all',\n    update: 'self',\n    find: 'self',\n    list: 'admin',\n    destroy: 'self'\n  }\n\n});\n\nexports.handleRequest = function (req, res) {\n  users.handle(req, res);\n};\n```\n\nPlease note that __settings must be the same across all functions__. So if you change any of the default values, make sure to replicate them accordingly.\n\n_When Google Cloud Functions support environment variables, we will change this approach so configuration can be unified and the copy/pasting avoided._\n\nIf you want to customize Schema validators with your own functions, take a look at the [Gstore Schema documentation](https://sebelga.gitbooks.io/gstore-node/content/schema/).\n\n## TODO/Wishlist\n\n* Google reCAPTCHA support on user creation and update.\n* Email service support (Mailgun, SendGrid, etc) for sending various confirmation messages.\n* Customizable cache TTL support for `authorization`.\n  * Currently, it stores values in session until user signs out or session expires.\n* Support other data stores (like MySQL).\n* Support JSON Web Tokens instead of client-sessions.\n\n__This is a work in progress.__\n","created":"2017-05-14T18:14:56.384Z","modified":"2017-05-14T18:14:56.384Z","lastPublisher":{"name":"pauloddr","email":"npm@pauloddr.com"},"owners":[{"name":"pauloddr","email":"npm@pauloddr.com"}],"other":{"_attachments":{},"_from":".","_id":"google-function-authorizer","_nodeVersion":"7.10.0","_npmOperationalInternal":{"host":"packages-12-west.internal.npmjs.com","tmp":"tmp/google-function-authorizer-0.1.0.tgz_1494785696162_0.884051978122443"},"_npmUser":{"name":"pauloddr","email":"npm@pauloddr.com"},"_npmVersion":"4.2.0","_rev":"1-20b85022f0d770fd22eda2d49c09493b","_shasum":"35aef648b0e66e7f1e015ae724b1ef45cdb31c70","author":{"name":"@pauloddr"},"bugs":{"url":"https://github.com/pauloddr/google-function-authorizer/issues"},"directories":{},"dist-tags":{"latest":"0.1.0"},"dist":{"shasum":"35aef648b0e66e7f1e015ae724b1ef45cdb31c70","tarball":"https://registry.npmjs.org/google-function-authorizer/-/google-function-authorizer-0.1.0.tgz"},"maintainers":[{"name":"pauloddr","email":"npm@pauloddr.com"}],"readmeFilename":"README.md","time":{"modified":"2017-05-14T18:14:56.384Z","created":"2017-05-14T18:14:56.384Z","0.1.0":"2017-05-14T18:14:56.384Z"}}}