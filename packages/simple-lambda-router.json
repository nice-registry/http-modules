{"name":"simple-lambda-router","version":"0.1.1","description":"Small router utility for lambda functions handling HTTP events from multiple resources and methods","main":"index.js","scripts":{"test":"cd test && mocha test-*.js"},"license":"MIT","devDependencies":{"chai":"^4.0.2","chai-as-promised":"^7.0.0","joi":"^10.6.0","mocha":"^3.4.2"},"repository":"https://github.com/brunomorency/simple-lambda-router","keywords":["lambda","routing","serverless","serverless-application-model","SAM","AWS"],"homepage":"https://github.com/brunomorency/simple-lambda-router#readme","gitHead":"aa12e75a385457819f0689148d015ad2fff886fd","versions":[{"number":"0.1.0","date":"2017-06-22T18:15:41.753Z"},{"number":"0.1.1","date":"2017-06-22T18:26:50.196Z"}],"readme":"# Use Case\nWhen building an serverless application on AWS Lambda  driven by events from API Gateway, there are several popular patterns: \n\n1. Every single HTTP endpoint and method gets its own dedicated lambda function implementing it\n1. There's a single HTTP endpoint sending all requests to one big lambda function\n1. You have a couple resources defined in API gateway which send requests to a set of lambda functions each handling a scope of your logic. For example, there could be a function handling all `GET`/`POST`/`PUT`/`DELETE` requests related to a `users` entity and another to handle requests for a `todos` entity.\n\nFor case 2 and 3 above, your lambda function will need to route the incoming request to the appropriate code to respond to it. *This is what I built this little library for*. \n\n**NOTE**: In its current state, routing is driven by the `resource` property of the request, not the `path`. This means that it works well if each valid path is defined as a resource in API gateway. However, until I complete routing based on `path`, it won't help you much if you have a single API resource setup with a greedy path. That's because all these requests will get to lambda with the same `resource` property, only the `path` will differ.\n\n## Bonus functionality\n\nIn addition to routing requests to the right handler, this package adds a few useful things:\n\n- **Promises**: Uses promises for async logic. Your handler code is expected to return a `Promise` when called.\n- **Error handling**: The router catches exceptions from the handler code result in a clean 500 error. Also, there's an extended `Error` class useful to reject requests with a specific status code.\n- **Response headers**: You can define default headers to be included in responses for all requests (e.g. CORS headers) and add more headers for specific requests in the handler code.\n- **Input validation**: You can define body and query parameters validation rules and the router will apply them. If body or query parameters don't match your validation rules, the request is rejected with appropriate error code and your handler code isn't executed. The way validation works allows setting default value for optional input.\n- **Request body parsing**: If the incoming request as a `Content-Type` header indicating the body is JSON data. It will be parsed into a JS object before it is passed to you handler code. \n\n# How It Works\n\n## Lambda Function Handler\nThe package exposes a `route()` method. It takes routing configuration and its return value is the handler of your lambda function. For example, if the code below is in a `index.js` file of your function, then `index.handler` would be defined as the handler for your lambda function.\n\n```javascript\nconst Router = require('simple-lambda-router')\nexports.handler = Router.route(\n  {\n    resources: {\n      '<HTTP_METHOD>:<API_RESOURCE>': <FILE_HANDLING_THAT_REQUEST>\n    },\n    headers: {\n      '<SOME_HTTP_RESPONSE_HEADER>': '<HEADER_VALUE>'\n    }\n  },\n  <OTHER_ARGUMENTS_TO_BE_PASSED_TO_YOUR_REQUEST_HANDLERS>\n)\n```\n\n## Route Handler Files\nFiles defined as handlers for a `method:resource` combo defined in `Router.route()` above must export a function called `handler` and may also export a `validate` object as follows:\n\n```javascript\nconst joi = require('joi')\nmodule.exports = {\n  handler: (request, context, <OTHER_ARGUMENTS_FROM_CALL_TO_ROUTER.ROUTE>) => {\n    return new Promise((resolve, reject) => {\n      resolve({\n        statusCode: 200,\n        body: {\n          someProp: 'the value'\n        },\n        headers: {\n          '<SOME_HTTP_RESPONSE_HEADER>': '<HEADER_VALUE>'\n        }\n      })\n    })\n  },\n  validate: {\n    queryStringParameters: <QUERYSTRING_VALIDATION_RULES>,\n    body: <BODY_VALIDATION_RULES>,\n  }\n}\n```\n\n### `handler`\nThe `handler` function gets the `request` and `context` arguments as if they were handling the  lambda function directly. It also gets all other arguments passed after the config in `Route.route()` \n(see first snippet above). \n\nYour handler function must return a Promise. It resolves to an object that contains a `statusCode`, `body` and (optional) `headers` property:\n\n- If `body` is an object, it will go through `JSON.stringify()` before being sent back. \n- HTTP header defined in the `headers` property are included in the response in addition to those included in the initial `Router.route()` call. If a given header is defined in both places, the value given in the here as precedence.\n\nIf your Promise is rejected or has uncaught exceptions, the router will send a `500 Internal Server Error` response back to lambda. You can reject with a specific HTTP error as follows:\n\n```javascript\nconst Router = require('simple-lambda-router')\nmodule.exports.handler = (request, context) => {\n  return new Promise((resolve, reject) => {\n    reject(new Router.error({ \n      statusCode:403, \n      message: 'Check with your admin to get access to this.'\n    }))\n  })\n}\n```\n\n### `validate`\nThe validate object lets you define validation rules for the request body and/or query parameters. Validation is super easy to use with the [Joi Object schema validation library](https://github.com/hapijs/joi) but you can use anything as long as you wrap it in a `validate` method compatible with [the Joi validate method](https://github.com/hapijs/joi/blob/master/API.md#validatevalue-schema-options-callback).\n\n```javascript\nconst joi = require('joi')\nmodule.exports = {\n  handler: (request, context) => {\n    ...\n  },\n  validate: {\n    // Validating using Joi library\n    queryStringParameters: joi.object({\n      status: joi.string().valid(['opened','completed']).required(),\n    }),\n    // Custom body validation/augment code\n    body: {\n      validate: (requestBody) => {\n        let error = null\n        if (!('requiredProp' in requestBody)) {\n          error = { \n            details: [\n              { message: 'Request body must contain a \"requiredProp\" property.' }\n            ]\n          }\n        }\n        let value = Object.assign({}, { propWithDefaultVal: 'default val' }, requestBody)\n        return { error, value }\n      }\n    }\n  }\n}\n```\n\n# Complete Example\nSee the `example` directory for a more complete example. Looking at tests may also be useful.\n\n","starsCount":1,"created":"2017-06-22T18:15:41.753Z","modified":"2017-06-22T18:32:53.033Z","lastPublisher":{"name":"brunomorency","email":"bruno@morency.me"},"owners":[{"name":"brunomorency","email":"bruno@morency.me"}],"other":{"_attachments":{},"_from":".","_id":"simple-lambda-router","_nodeVersion":"7.10.0","_npmOperationalInternal":{"host":"s3://npm-registry-packages","tmp":"tmp/simple-lambda-router-0.1.1.tgz_1498156008795_0.25787402829155326"},"_npmUser":{"name":"brunomorency","email":"bruno@morency.me"},"_npmVersion":"4.2.0","_rev":"3-9ec2e0d0ddcf030e8b719050c1bba404","_shasum":"bed4234504665170be18363df270319aee3d0235","author":{"name":"Bruno Morency","email":"bruno@morency.me"},"bugs":{"url":"https://github.com/brunomorency/simple-lambda-router/issues"},"directories":{"example":"examples","test":"test"},"dist-tags":{"latest":"0.1.1"},"dist":{"shasum":"bed4234504665170be18363df270319aee3d0235","tarball":"https://registry.npmjs.org/simple-lambda-router/-/simple-lambda-router-0.1.1.tgz"},"maintainers":[{"name":"brunomorency","email":"bruno@morency.me"}],"readmeFilename":"README.md","time":{"modified":"2017-06-22T18:32:53.033Z","created":"2017-06-22T18:15:41.753Z","0.1.0":"2017-06-22T18:15:41.753Z","0.1.1":"2017-06-22T18:26:50.196Z"},"users":{"brunomorency":true}}}