{"name":"formaline","version":"2.0.2","description":"formaline is a module for handling form requests ( HTTP POSTs / PUTs ) and for fast parsing of file uploads.","main":"lib/formaline.js","dependencies":{"poor-form":">=1.1.4 <1.2.0"},"devDependencies":{},"scripts":{"test":"node test.js & sleep 1; bash test.sh"},"repository":"https://github.com/rootslab/formaline","keywords":["formaline","formidable","good-form","poor-form","multipart","upload","form","connect","express","post","parser"],"license":"MIT","gitHead":"de4d0b16cd040cffcd98adfbb0885f519744c978","homepage":"https://github.com/rootslab/formaline","versions":[{"number":"0.6.4","date":"2011-09-27T01:04:04.937Z"},{"number":"0.6.5","date":"2012-10-27T11:49:27.018Z"},{"number":"0.6.6","date":"2012-11-05T22:30:48.060Z"},{"number":"0.6.7","date":"2012-11-06T22:58:11.524Z"},{"number":"2.0.0","date":"2012-11-24T15:40:49.249Z"},{"number":"2.0.1","date":"2012-12-03T22:01:47.584Z"},{"number":"2.0.2","date":"2015-02-19T19:08:32.075Z"}],"readme":"## Formaline v2.x\n\nFormaline extends [PoorForm](http://github.com/coolaj86/poor-form) to create a very developer-friendly form parser, and still easy to get at the guts.\n\nIf you don't think Formaline is light-weight enough for you, you're crazy.\nAlso, you'd probably really like [PoorForm](http://github.com/coolaj86/poor-form).\n\nThe **[Formaline v0.x](https://github.com/rootslab/formaline/tree/v0.x)** [documentation](https://github.com/rootslab/formaline/blob/v0.x/Readme.md) is available on the v0.x branch.\n\n## API\n\n  * [`Formaline.create(request, options)`](#formalinecreaterequest-options)\n  * [`Formaline#on('progress', fn)`](#formalineonprogress-function--)\n  * [`Formaline#on('field', fn)`](#formalineonfield-function-name-decodedvalue-)\n  * [`Formaline#on('file', fn)`](#formalineonfile-function-name-formfilestream-headers-)\n    * [`FormFile#name`](#formfile)\n    * [`FormFile#size`](#formfile)\n    * [`FormFile#type`](#formfile)\n    * [`FormFile#lastModifiedDate`](#formfile)\n    * [`FormFile#path`](#formfile)\n    * [`FormFile#headers`](#formfile)\n    * [`FormFile#<hashtype>`](#formfile) (md5, sha1, sha512, etc)\n  * [`Formaline#on('end', fn)`](#formalineonend-function-fields-files-)\n\n### Formaline.create(request, options)\n\nReturns an instance of `PoorForm` with a few extra events tacked on as described above.\n\nLike PoorForm, it returns null if either it's not a multi-part form or the form has already been parsed.\n\n#### Options\n\n    {\n        tmpDir: null || pathString || os.tmpDir()\n      , hashes: [\"md5\", \"sha1\", ...] || []\n      , arrayFields: [fieldNameString] || null\n    }\n\n##### tmpDir\n\nSet `tmpDir` to `null` if you plan to manage the file streams from the `file` event on your own\n(i.e. you want to store them in S3 or whatever and never let them hit the fs).\nAlso, in almost all cases `tmpDir` should be on the same partition as the final destination,\nso change it if the system's default tmp is a different partition than your destination.\n\n##### hashes\n\nAn array of hashes that should be performed on each file (fields are excluded).\nThe hash will be attached to the file before the `end` event.\n\n##### arrayFields\n\nWhen `end` fires it hands back a map for both `fields` and `files`,\nall of which are assumed to be arrays by default (as per the HTTP spec).\n\nHowever, if `arrayFields` is an array of field names (or an empty array),\ntwo special things happen:\n\n  1. All of the fields listed will always return an array, even if it's empty\n\n    I.E. The user created an album, but uploaded 0 photos.\n\n  2. All fields and files not listed in `arrayFields` will be treated as single values\n     (if the field is encountered multiple times, only the first value is kept)\n\n    I.E. If `username` is given twice, only the first value is kept.\n\n#### Example\n\n```javascript\n(function () {\n  \"use strict\";\n\n  var Formaline = require('formaline').Formaline\n    ;\n\n  // Using Connect, for example\n  app.use(function (req, res, next) {\n    var form = Formaline.create(req, {\n            tmpDir: '/mnt/my-app-data/tmp'\n          , hashes: ['md5']\n          , arrayFields: ['photos']\n        })\n      , fieldsMap\n      , filesMap\n      ;\n\n    if (!form) {\n      console.log(\"Either this was already parsed or it isn't a multi-part form\");\n      next();\n      return;\n    }\n\n    // form.on('field', ...)\n    // ...\n  });\n}());\n```\n\n### Formaline#on('progress', function () {})\n\nFires after `Formaline#loaded` is updated so you can compare that against `Formaline#total`.\n\n```javascript\nform.on('progress', function () {\n  var ratio = poorForm.loaded / poorForm.total\n    , percent = Math.round(ratio * 100)\n    ;\n\n  console.log(percent + '% complete (' + poorForm.loaded + ' bytes)');\n  // might be 0 because poorForm.total is Infinity when Content-Length is undefined\n  // I.E. Transfer-Encoding: chunked\n})\n```\n\n### Formaline#on('field', function (name, decodedValue) {})\n\nProvides the form name and decoded string\nabstracted from PoorForm's `fieldstart`, `fielddata`, and `fieldend` events\n(remember than a field's data is occasionally chunked across two `fielddata` events).\n\n```javascript\nform.on('field', function (key, value) {\n  // both key and value have been run through `str = decodeURIComponent(str)`\n  fieldsMap[key] = value;\n  console.log(key, value);\n})\n```\n\n### Formaline#on('file', function (name, formFileStream, headers) {})\n\nProvides the form name (not filename) as well as a FormFile stream (described below, has the filename),\nand all associated headers (generally not needed).\n\nRemember: If you specify `options.tmpDir = null`,\nyou are entirely responsible for writing the file to disk, GridStore, S3, the toilet, or wherever.\n\n```javascript\nform.on('file', function (key, formFile) {\n  // for example, we want to save to amazon s3 using knox\n  var s3 = require('knox').createClient({ key: '<api-key>', secret: '<secret>', bucket: '<foo>'})\n    , s3req\n    , metadata\n    ;\n\n  // and let's say we have a field called `metadata` containing a hash with metadata\n  // such as `lastModifiedDate` and `size` for every file to be uploaded\n  if (!fieldMaps.metadata) {\n    console.error('sad day, no metadata');\n  } else {\n    metadata = JSON.parse(fieldMaps.metadata[formFile.name]);\n  }\n\n  s3req = s3.put('/test/file.bin', {\n      'Content-Length': metadata.size\n    , 'Content-Type': 'application/octet-stream'\n  });\n  formFile.pipe(s3);\n\n  formFile.on('end', function () {\n    // formFile is an instance of EventEmitter, but it `JSON.stringify()`s as you would expect.\n    // Also note that some of the properties are added just before the `end` event fires.\n    formFile.lastModifiedDate = metadata.lastModifiedDate;\n    if (!formFile.sha1 === metadata.sha1) {\n      console.error(\"Oh No! The sha1 sums don't match!\");\n    }\n    console.log(key, JSON.stringify(formFile));\n  });\n\n  s3.on('response', function(res){\n    if (200 == res.statusCode) {\n      console.log('saved to %s', req.url);\n    } else {\n      console.error(\"fell on hard times, didn't save %s\", req.url);\n    }\n  });\n})\n```\n\n#### FormFile\n\nA simple EventEmitter FileStream (pausable, resumable, etc)\nabstracted from PoorForm's `fieldstart`, `fielddata`, and `fieldend` events.\n\n  * `name` is taken from the `filename` in the `Content-Disposition` \n  * `fieldname` is the actual name of the field\n  * `size` is the current byte size of the file, which changes until the `end` event is called\n  * `type` is the `contentType`\n  * `lastModifiedDate` is updated each time a chunk is written to the file\n  * `path` is the current file path (either in `/tmp` or a path you specified)\n  * `headers` is the array of MIME headers associated with the form\n  * `md5`, `sha1`, `sha256`, `sha512`, etc are attached as per the `options.hashes` array\n\n### Formaline#on('end', function (fields, files) {})\n\nCongratulations. You've reached the end of the form.\n\n  * `fields` is a map of arrays of Strings `{ \"anyFieldName\": [\"decodedStringValue\"] }`\n  * `files` is a map of arrays of FormFiles `{ \"anyFileName\": [aFormFile, anOtherFormFile] }`\n  * `options.arrayFields` changes the behavior such that only the listed fields are arrays and all others are singular\n\n```javascript\nform.on('end', function (fields, files) {\n  // Normally the values for each key of fields and files would be arrays\n  // However, I specified `arrayFields`, which means that those names not listed are not arrays\n  console.log(fields.username);\n  console.log(fields.password);\n\n  // this is an array because it would be by default if I ha\n  files.photos.forEach(function (formFile) {\n    // JSON.stringify ignores the non-enumerable properties of the underlying EventEmitter\n    console.log(JSON.stringify(formFile));\n  });\n\n  console.log('uploads complete');\n});\n```\n\nNOTE:\nI put a lot of thought (too much, in fact) into how to represent fields and files in a way which is both consistent and easy to use.\n\nIt makes sense to separate `fields` from `files`.\nTreating all fields as files would have unneccesary overhead in parsing.\nWhat you're likely to do with a field (store it in a database as metadata)\nis different from what you'll do with a file (store it in a file system).\n\nThe hybrid approach of mapping pure arrays makes it simple to ignore (and or error check)\nduplicate fields that should have been singular without the confusion of other common methodologies\n(see below).\n\nUsing maps where `username` and `categories` are sometimes treated as single-value fields\n(i.e. if only one `category` is selected in the browser UI)\nbut sometimes treated as arrays\n(i.e. a developer accidentally sends two `username` form parts)\nis inconsistent and likely to cause wierd breakage in your app.\n\nUsing pure arrays where you have to `.forEach`\nand handle the fields in a `switch` is ugly / cumbersome.\n\nAnother workaround is to require php-style field naming conventions such as `categories[]` and `username`, but PHP is &lt;insert-profanity-here&gt; and self-respecting individuals have a hard time taking anything that started with PHP seriously, even though it's atually not a terribly profane solution.\nThe downside to this solution is that it requires parsing field names.\n\n## Future Enhancements (TODO)\n\nThe following are abbreviated security concerns for a form handler with generous and reasonable defaults\n\n  * `error` - abstract `req.on('error')` and `poorForm.on('error', fn)` as to handle malformed requests\n  * `maxHeaderSize` - default 256 Bytes - prevent memory attacks\n  * `maxUniqueFieldNames` - default 1000 - prevent hash collision attacks\n  * `maxFieldSize` - default 4KB - prevent memory attacks\n  * `maxFieldTotalSize` - default 1MB - prevent memory attacks\n  * `maxFileSize` - default 4 GiB - prevent storage attacks\n  * `maxUploadSize` - default 16 GiB - prevent memory / storage attacks\n  * `removeIncomplete` - default true - ignore unless creating a resumable upload service\n\n# LICENSE\n\n  * Apache 2\n  * MIT\n","starsCount":1,"created":"2011-09-27T01:04:04.385Z","modified":"2015-02-19T19:08:32.075Z","lastPublisher":{"name":"coolaj86","email":"coolaj86@gmail.com"},"owners":[{"name":"rootslab","email":"44gatti@gmail.com"},{"name":"coolaj86","email":"coolaj86@gmail.com"}],"other":{"_attachments":{},"_from":".","_id":"formaline","_nodeVersion":"1.2.0","_npmUser":{"name":"coolaj86","email":"coolaj86@gmail.com"},"_npmVersion":"2.5.1","_rev":"1-e5c4929505da0fb981d017ce7427fc16","_shasum":"8850154c2419a0e030293e5203551490ec4131f1","bugs":{"url":"https://github.com/rootslab/formaline/issues"},"contributors":[{"name":"AJ ONeal","email":"coolaj86@gmail.com","url":"http://coolaj86.com"},{"name":"Guglielmo Ferri","email":"44gatti@gmail.com","url":"http://rootslab.it"}],"directories":{"lib":"./lib"},"dist-tags":{"latest":"2.0.2"},"dist":{"shasum":"8850154c2419a0e030293e5203551490ec4131f1","tarball":"http://registry.npmjs.org/formaline/-/formaline-2.0.2.tgz"},"maintainers":[{"name":"rootslab","email":"44gatti@gmail.com"},{"name":"coolaj86","email":"coolaj86@gmail.com"}],"readmeFilename":"README.md","time":{"modified":"2015-02-19T19:08:32.075Z","created":"2011-09-27T01:04:04.385Z","0.6.4":"2011-09-27T01:04:04.937Z","0.6.5":"2012-10-27T11:49:27.018Z","0.6.6":"2012-11-05T22:30:48.060Z","0.6.7":"2012-11-06T22:58:11.524Z","2.0.0":"2012-11-24T15:40:49.249Z","2.0.1":"2012-12-03T22:01:47.584Z","2.0.2":"2015-02-19T19:08:32.075Z"},"users":{"pid":true}}}