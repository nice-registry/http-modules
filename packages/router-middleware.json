{"name":"router-middleware","version":"2.2.2","description":"Write fully featured http services and streaming templates without the bloat","main":"index.js","scripts":{"test":"tape ./test/test-*.js"},"keywords":["express","router","tree","tree router","stream","streaming template","stream template"],"repository":"https://github.com/rook2pawn/router-middleware","license":"MIT","homepage":"https://github.com/rook2pawn/router-middleware#readme","dependencies":{"concat-stream":"^1.6.0","methods":"^1.1.1"},"devDependencies":{"response":"^0.18.0","supertest":"^1.0.1","tape":"^4.6.0"},"gitHead":"d975b553825ec368925f928ca063d1b17c12d2d9","_resolved":"file:router-middleware","versions":[{"number":"1.0.0","date":"2015-06-28T08:42:04.091Z"},{"number":"1.0.1","date":"2015-06-28T18:20:01.831Z"},{"number":"1.0.2","date":"2015-06-30T11:40:00.676Z"},{"number":"1.0.3","date":"2015-07-10T09:34:30.103Z"},{"number":"1.0.4","date":"2015-07-10T11:45:00.815Z"},{"number":"1.0.5","date":"2015-07-13T14:28:17.506Z"},{"number":"1.0.6","date":"2015-07-13T14:53:57.326Z"},{"number":"1.0.7","date":"2015-08-06T12:21:52.878Z"},{"number":"2.0.0","date":"2015-12-31T14:37:13.494Z"},{"number":"2.0.1","date":"2016-01-17T22:25:24.872Z"},{"number":"2.0.2","date":"2016-01-17T23:52:14.658Z"},{"number":"2.0.3","date":"2016-01-18T00:27:19.023Z"},{"number":"2.0.4","date":"2016-09-17T14:23:44.040Z"},{"number":"2.0.5","date":"2016-09-17T15:44:21.575Z"},{"number":"2.0.6","date":"2016-09-18T02:50:13.299Z"},{"number":"2.0.7","date":"2016-09-18T15:22:58.784Z"},{"number":"2.1.0","date":"2016-09-18T16:08:34.699Z"},{"number":"2.1.1","date":"2016-09-18T17:31:13.770Z"},{"number":"2.1.2","date":"2016-09-19T07:03:04.680Z"},{"number":"2.1.3","date":"2016-09-25T06:25:51.061Z"},{"number":"2.1.5","date":"2017-01-27T11:05:11.954Z"},{"number":"2.1.6","date":"2017-01-27T11:12:42.013Z"},{"number":"2.1.7","date":"2017-01-27T15:48:28.381Z"},{"number":"2.1.8","date":"2017-02-05T07:47:17.572Z"},{"number":"2.1.9","date":"2017-02-06T23:38:02.586Z"},{"number":"2.2.0","date":"2017-06-16T07:13:49.094Z"},{"number":"2.2.1","date":"2017-06-16T07:29:48.895Z"},{"number":"2.2.2","date":"2017-06-20T06:03:19.781Z"}],"readme":"Write fully featured http services and streaming templates without the bloat\n\n[![Build Status](https://travis-ci.org/rook2pawn/router-middleware.svg?branch=master)](https://travis-ci.org/rook2pawn/router-middleware)\n\n# router-middleware\n\n\n## Supports\n* Legacy Support for Express Template Engines\n* Legacy Support for Express Routes\n* Legacy Support for Express Syntax \n\n## Features\n* Chainable middleware\n* familiar req.params and req.query are there\n* identical routing to what you are used to\n\n## Any Template Engine\n* Any Express-compatible template engine\n* Any stream-based template engine\n* Tagged Template Strings\n* You design it!\n\n## Any Fileserver\n* Ecstatic\n* express.static \n* fs\n\n## How to do a simple GET Fall-Through\n    var http = require('http')\n    var router = require('router-middleware')\n    var ecstatic = require('ecstatic')({root:__dirname })    \n    var app = router();\n    app.fileserver(ecstatic);\n    var server = http.createServer(app)\n  \n    app.get('/admin', function(req,res,next) {\n      if (some_condition) {\n        next(); // will now pass through to the fileserver \n                // i.e. /admin/index.html or /admin.html\n      } else {\n        res.writeHead(403)\n        res.write('Denied, sorry')\n        res.end()\n      }\n    })    \n \n\n### Example\n    var http = require('http')\n    var router = require('router-middleware')\n    var app = router()\n    var server = http.createServer(app)\n  \n    app.get('/user/:username', function(req,res,next) {\n      res.writeHead(200)\n      res.end(\"Hello \" + req.params.username + \"!\")\n    })    \n \n    // GET /user/joe\n    // Hello joe!\n\n### With Fileserver Ecstatic\n    var http = require('http')\n    var router = require('router-middleware')\n    var app = router()\n    var ecstatic = require('ecstatic')({root:__dirname })\n    var server = http.createServer(app)\n\n    app.fileserver(ecstatic)\n\n    // any custom routes you set will have precedence \n    // all other GET requests falls-through to the fileserver\n\n### With Fileserver Express\n    var http = require('http')\n    var router = require('router-middleware')\n    var app = router() \n    var express = require('express')\n    var server = http.createServer(app)\n\n    app.fileserver(express.static('mydirectory'))\n\n    // any custom routes you set will have precedence \n    // all other GET requests falls-through to the fileserver\n\n### With a Express Template Engine\n    var router = require('router-middleware')\n    var app = router()\n    app.engine('view', yourengine) // i.e. index.view\n    app.set('views', './views'); // specify the views directory\n    app.set('view engine', 'view'); // register the template engine (i.e. for extension .view)\n\n### With a Stream Template Engine\n    var router = require('router-middleware')\n    var through = require('through')\n\n    var app = router()\n    app.streamengine('view', yourengine)\n    app.set('views', './views'); // specify the views directory\n    app.set('view engine', 'view'); // register the template engine\n\n\nwhere \"yourengine\" callback will be called with filepath, options, and the response object.\n\nExample callback:\n\n    function (filePath, options, res) { // define the template engine\n      fs\n      .createReadStream(filePath)\n      .pipe(through(function write(data) {\n          this.queue(data.toString().toUpperCase()) //data *must* not be null\n        },  \n        function end () { //optional\n          this.queue(null)\n        })) \n      .pipe(res)\n    }\n\n## Main Methods\n\n### .\\[method\\] (get, post, ... etc)\n\nAttach a handler to any [HTTP Method](https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods) from the [full method verb list](https://github.com/jshttp/methods/ \"METHODS\")\nHandler has the signature function(req, res, next).\n\n\n### .get\n\n    app.get('/user/email',function(req,res,next) {\n      res.write('foo@boop.com');\n      res.end();\n    })\n  \n### .post\n  \n    // suppose we send JSON payload via POST\n    // { username: 'Manny', species: 'cat' }\n    \n    app.post('/user/email',function(req,res,next) {\n      \n      // req.body will be the JSON parsed object that is sent on the post\n      // req.body.username == 'Manny';\n      // req.body.species == 'cat';\n    })\n\n### .use\n\nAdd a use handler that is placed in front of every call.\n\n    app.use(logger);\n    app.use(parser);\n\n### .fileserver\n\nAttach any fileserver. Any custom routes you set will have precedence. All other unmatched GET requests falls-through to the fileserver.\n\n## Accessory methods\n\n### .engine\n\nUse templates with the same signature as express engines.\n\n    app.engine('view', yourengine) // i.e. index.view\n    app.set('views', './views'); // specify the views directory\n    app.set('view engine', 'view'); // register the template engine (i.e. for extension .view)   \n\n### .streamengine\n\n    app.streamengine('view', your_stream_engine)\n    app.set('views', './views'); // specify the views directory\n    app.set('view engine', 'view'); // register the template engine\n\n#### An Example streamengine \n\n    var HtmlTemplate = require('html-template')\n    app.streamengine('view', function(filename, opts, res) {\n      // looking for {template: <template string name>, list: <list of objects to write> }\n      res.setHeader('Content-Type','text/html');\n      var html = HtmlTemplate()\n      fs.createReadStream(filename)\n          .pipe(html)\n          .pipe(res)\n      ;\n      opts.forEach(function(opt) {\n        var template = html.template(opt.template,{include:false});\n        opt.list.forEach(function(obj) {\n          template.write(obj)\n        })\n        template.end()\n      })\n    })\n\n#### Using this example streamengine\n\n    res.streamrender('teamslist', [{\n      template:'poll',\n      list:JSON.parse(fs.readFileSync('poll_ap.json')).map(function(poll) {\n        return {\n          '[key=week]': {\n            _text : poll.week\n          },\n          '[key=date]': {\n            _text : poll.date\n          },\n          '[key=position]': {\n            _text : poll.position\n          },\n          '[key=school]': {\n            _text : poll.school,\n            href: '/team/'.concat(poll.uuid)\n          },\n          '[key=conference]': {\n            _text : poll.conference\n          }\n        }\n      })\n    }]\n\nWhere teamslist.view looks like\n\n    <table>\n      <tr>\n        <th>Week</th>\n        <th>date</th>\n        <th>Position</th>\n        <th>School</th>\n        <th>Conference</th>\n      </tr>\n      <tr template='poll'>\n        <td key='week'></td>  \n        <td key='date'></td>  \n        <td key='position'></td>  \n        <td><a key='school'></a></td>  \n        <td key='conference'></td>  \n      </tr>\n    </table>\n\n### .set\n\nUsed to set properties for .engine and .streamengine.\n\n    app.set('views', './views'); // specify the views directory\n    app.set('view engine', 'view'); // register the template engine (i.e. for extension .view)   \n\n\n### A Tale of Two Servers, Two Stories\n\nSuppose customer Jim is shopping for shoes online. \n\nServer A is built using Express and has a nice cache algorithm and perhaps Nginx in front serving out both the CDN and the cache hits and proxying on top of Node. The architect has deemed that every night at the lowest peak traffic, most pages would be recalculated, cache would be invalidated, and new cache would be resprinkled upon the CDN servers. Or items low in inventory automatically get recalculated and get new cache. This is fine. But then, there is a cache miss. Something changed, and it happened at a period of intense database traffic and activity. CPU Loads are huge. Jim, shopping for shoes, has to stare at a somewhat empty screen for a few seconds, then, like rain from heaven, there is a huge burst of traffic as alas his delivery is here and he can browse that page. \n\nServer B is built on top of router-middleware and it too, has a cache algorithm. However cache misses aren't a cause for concern. The dev ops people sleep soundly while non-cached pages are being served fresh NodeJS produced HTML. Jim is browsing through the shoe catalog and happens to be browsing during a period where there is some intense traffic around the database and even though the data is coming out slowly, Jim doesn't have to wait while the traffic is being produced: he just gets it as it comes out. Is this javascript on the front calling out back home and doing some websocket or streaming over sockets? Nope. This is plain old HTML. Furthermore, there aren't any concerns about the size of the result-set. We know its going to come out as fast as the server can deliver, and at the capacity the the client can consume. There is no idle time, CPU loads are regular we see a nice even flat line with very little irregularity or spiking of CPU, Disk and other I/O usage. Likewise, Jim's computer doesn't suffer from having to go from completely idle to 100% of load simply because the traffic is finally here and the entire result set came in (or even paginated). It works at a smooth and steady pace.\n\nHow is this done? A router that is purpose-built expressly for \n\n* Streaming Data with Templates over HTTP/HTML\n* Streaming Data Webservices over HTTP \n* Producing smoother CPU, Disk, I/O usages for *any size* result set of data that needs to be relayed\n* More scalability!\n\n\nTo be fair, streaming data webservices over HTTP can be done with something as simple as, and yes, Express is suitable as well for this task.\n\n    http.createServer(function(req,res) {\n      mystream.pipe(res) \n    })\n\n\n\n\n### html-template front and center\n\nThe example here is using the very awesome [html-template](https://npmjs.org/package/html-template) as its stream mechanism, however you are free to roll your own and simply use the callback in streamengine.\n\n\n### Example\n\nUsing [html-template](https://npmjs.org/package/html-template) and [ecstatic](https://npmjs.org/package/estatic)\n\n    var router = require('router-middleware')\n    var HtmlTemplate = require('html-template')\n    var path = require('path')\n    var ecstatic = require('ecstatic')({root:path.join(__dirname,'web') })\n\n    var app = router()\n    app.set('views', './views'); // specify the views directory\n    app.set('view engine', 'view'); // register the template engine\n    app.streamengine('view', function(filename, opts, res) {\n      // looking for {template: <template string name>, list: <list of objects to write> }\n      res.setHeader('Content-Type','text/html');\n      var html = HtmlTemplate()\n      fs.createReadStream(filename)\n          .pipe(html)\n          .pipe(res)\n      ;\n      var template = html.template(opts.template);\n      opts.list.forEach(function(obj) {\n        template.write(obj)\n      })  \n      template.end()\n    })\n    app.fileserver(ecstatic)\n\nAnd you could invoke it through a route like this\n\n    app.get('/', function(req,res) {\n      res.streamrender('animal_list', {\n        template:'animal',\n        list: [\n          { \n            '[key=name]' : {\n              _text : 'Aardvark',\n              href : \"animal/aardvark\"\n            }\n          },\n          { \n            '[key=name]' : {\n              _text : 'Cat',\n              href : \"animal/cat\"\n            }\n          }\n      })\n    })\n\nWhere the arguments and options of res.streamrender end up going to the user-defined callback at app.streamengine, \nand this would lookup 'views/animal_list.view' whose content was something like\n\n    <div template='animal'>\n       <a key=\"name\"></a>\n    </div>\n\n\nTo produce \n\n\n    <div>\n      <a href=\"animal/aardvark\">Aardvark</a>\n    </div>\n    <div>\n      <a href=\"animal/cat\">Cat</a>\n    </div>\n\n\nNote that a request for anything that does not match any predefined GET routes falls through to any defined fileserver, in this case, ecstatic\n\n    var ecstatic = require('ecstatic')({root:path.join(__dirname,'web') })\n\nSo while a request to \"/\" gives us the streamrender list, \"/api\"  would default to the fileserver which in this case would look up /web/api/index.html.\n\n\n### Why?\n\nBecause the use case is so compelling and express simply could not support it. The use case being able to stream responses of templated data. For instance: suppose I load the top 1000 selling shoes from a shoe outlet. Now suppose each shoe has a whole bunch of data with each database entry and for some reason or another the DB lookup is taking a bit longer to complete, and that each entry is going to be formatted according to some HTML template. What we do not want is to have to have the user wait for the entire thing to be finished before they even see one shoe being listed: we want to be able to stream back the results to the user in real time as they are being loaded by the database or whatever particular constraints there are on the service.\n\nOr consider a purely HTTP service that we are writing. We know for a fact we won't have server-to-browser relationship and instead it will be service to service. We want these **services to be composable**. We can have one server deliver results and have the consuming server simply pipe it in to its next destination. \n\n### What's Wrong with Wait on Completion?\n\nIf we wait on completion, here's what goes wrong:\n\n1. It doesn't scale. If the result set is larger than available memory, the computer is done.\n2. It doesn't scale. Waiting on completion will result in idle-cpus that wait then explode with usage when completed. Streams allow the intelligent use of resources and maximizes scalability since we are allowing both producers and consumers to pipe results into toolchains before completion, allowing the computer to work on an as needed basis.\n3. Non-Composibility. Good tools often follow UNIX tool principles. \n\n\n\n\n\n### Contributions\n\nContributions are welcome! Pull requests are promptly reviewed.\n\n\n### License\n\nThe MIT License (MIT)\nCopyright (c) 2016 David Wee - rook2pawn@gmail.com\n\nPermission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n","created":"2015-06-28T08:42:04.091Z","modified":"2017-06-20T06:03:19.781Z","lastPublisher":{"name":"rook2pawn","email":"rook2pawn@gmail.com"},"owners":[{"name":"rook2pawn","email":"rook2pawn@gmail.com"}],"other":{"_attachments":{},"_from":"router-middleware","_id":"router-middleware","_nodeVersion":"7.3.0","_npmOperationalInternal":{"host":"s3://npm-registry-packages","tmp":"tmp/router-middleware-2.2.2.tgz_1497938599604_0.9696898811962456"},"_npmUser":{"name":"rook2pawn","email":"rook2pawn@gmail.com"},"_npmVersion":"3.10.10","_rev":"9-142468f7f72b7c7322e20ceabd7414b9","_shasum":"52176a4362647e051790847e8f808e91b3587fbd","author":{"name":"David Wee","email":"rook2pawn@gmail.com","url":"http://rook2pawn.com"},"bugs":{"url":"https://github.com/rook2pawn/router-middleware/issues"},"directories":{},"dist-tags":{"latest":"2.2.2"},"dist":{"shasum":"52176a4362647e051790847e8f808e91b3587fbd","tarball":"https://registry.npmjs.org/router-middleware/-/router-middleware-2.2.2.tgz"},"maintainers":[{"name":"rook2pawn","email":"rook2pawn@gmail.com"}],"readmeFilename":"README.md","time":{"modified":"2017-06-20T06:03:19.781Z","created":"2015-06-28T08:42:04.091Z","1.0.0":"2015-06-28T08:42:04.091Z","1.0.1":"2015-06-28T18:20:01.831Z","1.0.2":"2015-06-30T11:40:00.676Z","1.0.3":"2015-07-10T09:34:30.103Z","1.0.4":"2015-07-10T11:45:00.815Z","1.0.5":"2015-07-13T14:28:17.506Z","1.0.6":"2015-07-13T14:53:57.326Z","1.0.7":"2015-08-06T12:21:52.878Z","2.0.0":"2015-12-31T14:37:13.494Z","2.0.1":"2016-01-17T22:25:24.872Z","2.0.2":"2016-01-17T23:52:14.658Z","2.0.3":"2016-01-18T00:27:19.023Z","2.0.4":"2016-09-17T14:23:44.040Z","2.0.5":"2016-09-17T15:44:21.575Z","2.0.6":"2016-09-18T02:50:13.299Z","2.0.7":"2016-09-18T15:22:58.784Z","2.1.0":"2016-09-18T16:08:34.699Z","2.1.1":"2016-09-18T17:31:13.770Z","2.1.2":"2016-09-19T07:03:04.680Z","2.1.3":"2016-09-25T06:25:51.061Z","2.1.5":"2017-01-27T11:05:11.954Z","2.1.6":"2017-01-27T11:12:42.013Z","2.1.7":"2017-01-27T15:48:28.381Z","2.1.8":"2017-02-05T07:47:17.572Z","2.1.9":"2017-02-06T23:38:02.586Z","2.2.0":"2017-06-16T07:13:49.094Z","2.2.1":"2017-06-16T07:29:48.895Z","2.2.2":"2017-06-20T06:03:19.781Z"}}}