{"name":"retell","description":"When API testing slows you down, retell HTTP responses","version":"1.1.1","config":{"tag":"next"},"keywords":["test","testing","mock","stub","http","replay","vcr","api"],"main":"./lib","scripts":{"build":"gulp build","test":"mocha","prepublish":"gulp build","postpublish":"gulp tag"},"dependencies":{"babel-runtime":"^6.11.6","debug":"^2.0.0","js-string-escape":"~1.0.0","normalize-url":"^1.6.0"},"devDependencies":{"async":"^0.9.0","babel":"^6.5.2","babel-eslint":"^6.1.2","babel-plugin-transform-runtime":"^6.12.0","babel-preset-nodejs-lts":"^2.0.1","babel-register":"^6.11.6","body-parser":"^1.12.3","compression":"^1.6.0","del":"^1.1.1","eslint":"^0.20.0","express":"^4.12.3","gulp":"^3.8.11","gulp-babel":"^6.1.2","gulp-eslint":"^0.11.1","gulp-exec":"^2.1.1","gulp-sourcemaps":"^1.5.2","gulp-util":"^3.0.4","mocha":"^2.2.4","request":"^2.55.0"},"repository":"https://github.com/narqo/node-retell","licenses":[{"type":"MIT","url":"https://github.com/narqo/node-retell/blob/master/MIT-LICENSE"}],"gitHead":"8e3763f2f753c435fd2873f531ab1b7332675976","homepage":"https://github.com/narqo/node-retell#readme","versions":[{"number":"1.0.0","date":"2016-07-28T09:46:40.867Z"},{"number":"1.1.0","date":"2016-08-04T22:21:15.401Z"},{"number":"1.1.1","date":"2016-09-18T19:54:51.349Z"}],"readme":"# Node Retell \n\n***\n\nnode-retell is **a fork** of [node-replay](https://github.com/assaf/node-replay) library, \nas original library is abandoned and unmaintained. \n\n***\n\n### When API testing slows you down: retell recorded HTTP responses\n\nThings that will ruin your day when tests make HTTP requests to other services:\n\n- That other service has the uptime of Twitter's API\n- Network late ............ ncy\n- Being-rate limited and having to wait an hour for the next test run\n- Same request returns different result each time\n- Everyone else on the network is deep in BitTorrent territory\n\nThings **node-retell** can do to make these problems go away:\n\n- Record API response once, replay as often as necessary\n- Stub HTTP requests (TBD)\n- Replay different responses to same request (great for testing error handling)\n- Not suck\n\n\n## How to use node-retell\n\nLike this:\n\n```bash\nnpm install retell\n```\n\nNow write some simple test case:\n\n```javascript\nconst assert  = require('assert');\nconst HTTP    = require('http');\nconst retell  = require('retell');\n\nHTTP.get({ hostname: 'www.iheartquotes.com', path: '/api/v1/random' }, function(response) {\n  var body = '';\n  response.on('data', function(chunk) {\n    response.body = response.body + chunk;\n  });\n  response.on('end', function() {\n\n    // Now check the request we made to the I <3 Quotes API\n    assert.equal(response.statusCode, 200);\n    assert.equal(response.body, 'Oxymoron 2. Exact estimate\\n\\n[codehappy] http://iheartquotes.com/fortune/show/38021\\n');\n    console.log('Woot!');\n\n  });\n});\n```\n\nThis, of course, will fail the first time you run it.  You'll see:\n\n```\nError: Connection to http://www.iheartquotes.com:80/api/v1/random refused: not recording and no network access\n    at Array.0 (/Users/assaf/projects/node-replay/lib/replay/proxy.coffee:87:21)\n    at EventEmitter._tickCallback (node.js:192:40)\n```\n\nUnless you tell it otherwise, **node-retell** runs in `replay` mode. In this mode \nit will *replay* any previously captured HTTP response, but it will not allow\nany outgoing network connection.\n\nThat's the default mode for running tests. \"Why?\" you ask.  Good question.\nRunning in `replay` mode forces any test you run to use recorded responses, and\nso it will run (and fail or pass) the same way for anyone else, any other day of\nthe week, on whatever hardware they use.  Even if they're on the AT&T network.\n\nRunning in `replay` mode helps you write repeatable tests.  Repeatable tests are\na Good Thing.\n\nSo the first thing you want to do to get that test to pass, is to run\n**node-retell** in `record` mode.  In this mode it will replay any recorded\nresponse, but if no response was recorded, it will make a request to the server\nand capture the response.\n\nLet's do that:\n\n```bash\nNODE_RETELL_MODE=record node test.js\n```\n\nThat wasn't too hard, but the test is still failing.  \"How?\"  You must be\nwondering and scratching your head in total disbelief.  It's actually quite\nsimple.\n\nEvery request you make to 'I 3> Quotes' returns a different quote, and that test\nis looking for a very specific quote.  So the test will fail, and each time fail\nwith a different error.\n\nSo one way we can fix this test is to change the assertion.  Look at the error\nmessage, get the actual quote and make the assertion look for that value.\n\nNow run the test:\n\n```bash\n$ node test.js\n=> Woot!\n```\n\nDid the test pass?  Of course it did.  Run it again.  Still passing?  Why, yes.\n\nSo let's have a look at that captured response.  All the responses recorded for\n'I <3 Quotes>' will be listed here:\n\n```bash\nls fixtures/www.iheartquotes.com/\n```\n\nThere should be only one file there, since we only recorded one response.  The\nfile name is a timestamp, but feel free to rename it to something more\ndescriptive.\n\nThe name of a response file doesn't matter, it can be whatever you want.  The\nname of the directory does, though, it matches the service hostname (and port\nwhen not 80).\n\nSo that was one way to fix the failing test.  Another one is to change the\nrecorded response to match the assertion.  Being able to edit (or create new)\nresponses is quite important. Sometimes it's the easiest way to create mock\nresponses for testing, e.g. if you're trying to test failure conditions that are\nhard to come by.\n\nSo let's edit the response file and change the body part, so the entire response\nreads like this:\n\n```\nGET /api/v1/random\n\nHTTP/1.1 200 OK\nserver: nginx/0.7.67\ndate: Fri, 02 Dec 2011 02:58:03 GMT\ncontent-type: text/plain\nconnection: keep-alive\netag: \"a7131ebc1e81e43ea9ecf36fa2fdf610\"\nx-ua-compatible: IE=Edge,chrome=1\nx-runtime: 0.158080\ncache-control: max-age=0, private, must-revalidate\ncontent-length: 234\nx-varnish: 2274830138\nage: 0\nvia: 1.1 varnish\n\nOxymoron 2. Exact estimate\n\n[codehappy] http://iheartquotes.com/fortune/show/38021\n```\n\nAll responses are stored as text files using the simplest format ever, so you\ncan edit them in any text editor:\n\n- First comes the request method and path (including query string)\n- Followed by any headers sent as part of the request (like `Accept` and `Authorization`)\n- Then an empty line\n- Next the response status code and (optional) HTTP version number\n- Followed by any headers sent as part of the response\n- Then another empty line\n- And the rest taken by the response body\n\nIf you need to use regular expressions to match the request URL, add `REGEXP`\nbetween the method and path, for example:\n\n```\nGET REGEXP /\\/Aregexp\\d/i\n\nHTTP/1.1 200 OK\nContent-Type: text/html\n```\n\n\n## Settings\n\nWe've got them.  Just enough to make you happy and not enough to take all day to\nexplain.\n\nThe first and most obvious is the mode you run **node-retell** in:\n\n**bloody** -- All requests go out, none get replayed.  Use this if you want to\nremember what life was before you started using **node-retell**.  Also, to test\nyour code against changes to 3rd party API, because these do happen.\n\n**cheat** -- Replays recorded responses, and allow HTTP outbound requests.  This\nis mighty convenient when you're writing new tests or changing code to make new,\nun-recorded HTTP requests, but you haven't quite settled on which request to\nmake, so you don't want any responses recorded quite yet.\n\n**record** -- Replays recorded responses, or captures responses for future\nreplay.  Use this whenever you're writing new tests or code that makes new HTTP\nrequests.\n\n**replay** -- Replays recorded responses, does not allow outbound requests.\nThis is the default mode.  That's another way of saying, \"you'll be running in\nthis mode most of the time\".\n\nYou can set the mode by setting the environment variable `NODE_RETELL_MODE` to one of\nthese values:\n\n```bash\nNODE_RETELL_MODE=record node test.js\n```\n\nOf from your code by setting `retell.mode` in your code:\n\n```javascript\nconst retell = require('retell');\nretell.mode = 'record';\n```\n\nOf course, **node-retell** needs to store all those captured responses somewhere,\nand by default it will put them in the directory `fixtures`.  Bet you have an\nidea for a better directory name.  Easy to change.\n\nLike this:\n\n```javascript\nretell.fixtures = __dirname + '/fixtures/retell';\n```\n\nYou can tell **node-retell** what hosts to treat as \"localhost\".  Requests to\nthese hosts will be routed to 127.0.0.1, without capturing or replay.  This is\nparticularly useful if you're making request to a test server and want to use\nthe same URL as production.\n\nFor example:\n\n```javascript\nretell.localhost('www.example.com');\n```\n\nIf you don't want requests going to specific server, you can add them to the\ndrop list.  For example, Google Analytics, where you don't care that the request\ngo through, and you don't want to record it.\n\n```javascript\nretell.drop('www.google-analytics.com', 'rollbar.com');\n```\n\nLikewise, you can tell **node-reply** to pass through requests to specific hosts:\n\n```javascript\nretell.passThrough('s3.amazonaws.com');\n```\n\nIf you're running into trouble, try turning debugging mode on.  It helps.\nSometimes.\n\n```bash\n$ DEBUG=retell node test.js\n=> Requesting http://www.iheartquotes.com:80/api/v1/random\n=> Woot!\n```\n\nBy default, **node-retell** will record the following headers with each request,\nand use only these headers when matching pre-recorded requests:\n\n- Headers starting with `Accept` (eg `Accept-Encoding`)\n- `Authorization`\n- `Body` (used to match the body of a POST request)\n- `Content-Type`\n- `Host`\n- Headers starting with `If-` (eg `If-Modified-Since`)\n- Headers starting with `X-` (eg `X-Requested-With`)\n\nYou can modify the list of matched headers, adding or removing headers, by\nchanging the value of `retell.headers`.  The value is an array of regular\nexpressions.\n\nFor example, to capture `content-length` (useful with file uploads):\n\n```javascript\nretell.headers.push(/^content-length/);\n```\n\nSince headers are case insensitive, we always match on the lower case name.\n\n\n## Geeking\n\nTo make all that magic possible, **node-retell** replaces\n`require('http').request` with its own method.  That method returns a\n`ProxyRequest` object that captures the request URL, headers and body.\n\nWhen it's time to fire the request, it gets sent through a chain of proxies.\nThe first proxy to have a response, returns it (via callback, this is Node.js\nafter all).  That terminates the chain.  A proxy that doesn't have a response\nstill has to call the callback, but with no arguments.  The request will then\npass to the next proxy down the chain.\n\nThe proxy chain looks something like this:\n\n- Logger dumps the request URL when running with `DEBUG=retell`\n- The pass-through proxy will pass the request directly to the server in `bloody` mode, or when talking to `localhost`\n- The recorder proxy will either *replay* a captured request (if it has one), talk to the server and capture the response\n  (in `record` mode), or pass to the next proxy\n- The pass-through proxy (2nd one) will pass the request to the server in `cheat` mode, return nothing in all other\n  modes\n\nLoading pre-recorded responses to memory, from where they can be replayed, and\nstoring new ones on disk, is handled by the `Catalog`.\n\n\n## Final words\n\n**node-retell** is a fork of **node-replay** and released under the MIT license.  \nPull requests are welcome.\n","created":"2016-07-28T09:46:40.867Z","modified":"2016-09-18T19:54:51.349Z","lastPublisher":{"name":"varankinv","email":"nek.narqo@gmail.com"},"owners":[{"name":"varankinv","email":"nek.narqo@gmail.com"}],"other":{"_attachments":{},"_from":".","_id":"retell","_nodeVersion":"6.6.0","_npmOperationalInternal":{"host":"packages-16-east.internal.npmjs.com","tmp":"tmp/retell-1.1.1.tgz_1474228489326_0.07539942068979144"},"_npmUser":{"name":"varankinv","email":"nek.narqo@gmail.com"},"_npmVersion":"3.10.7","_rev":"1-6e04f87d92b946b163aa0cd76194d04a","_shasum":"7e15a35eb0b6e43be81ea30e7cef8d96f3785f3b","author":{"name":"Assaf Arkin","email":"assaf@labnotes.org","url":"http://labnotes.org/"},"bugs":{"url":"https://github.com/narqo/node-retell/issues"},"directories":{},"dist-tags":{"latest":"1.1.1"},"dist":{"shasum":"7e15a35eb0b6e43be81ea30e7cef8d96f3785f3b","tarball":"http://registry.npmjs.org/retell/-/retell-1.1.1.tgz"},"maintainers":[{"name":"varankinv","email":"nek.narqo@gmail.com"}],"readmeFilename":"README.md","time":{"modified":"2016-09-18T19:54:51.349Z","created":"2016-07-28T09:46:40.867Z","1.0.0":"2016-07-28T09:46:40.867Z","1.1.0":"2016-08-04T22:21:15.401Z","1.1.1":"2016-09-18T19:54:51.349Z"}}}