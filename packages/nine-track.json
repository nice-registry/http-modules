{"name":"nine-track","description":"Record and playback HTTP requests","version":"3.0.3","homepage":"https://github.com/twolfson/nine-track","repository":"https://github.com/twolfson/nine-track","licenses":[{"type":"MIT","url":"https://github.com/twolfson/nine-track/blob/master/LICENSE-MIT"}],"main":"lib/nine-track","engines":{"node":">= 0.10.0"},"scripts":{"precheck":"twolfson-style precheck lib/ test/","lint":"twolfson-style lint lib/ test/","test":"rm -r test/actual-files || true; npm run precheck && mocha --reporter dot && npm run lint"},"dependencies":{"async":"~0.2.10","clone":"~0.1.11","concat-stream":"~1.2.1","fs-memory-store":"~0.2.0","mkdirp":"~0.3.5","request":"~2.30.0","underscore":"~1.5.2"},"devDependencies":{"body-parser":"~1.11.0","chai":"~1.8.1","express":"~3.4.7","foundry":"~4.3.2","foundry-release-git":"~2.0.2","foundry-release-npm":"~2.0.2","jscs":"~1.10.0","jshint":"~2.5.10","mocha":"~1.11.0","pem":"~1.4.0","raw-body":"~1.1.5","request-mocha":"~0.2.0","rimraf":"~2.2.5","twolfson-style":"~1.6.0"},"keywords":["http","record","playback","cassette","vcr","middleware","8-track"],"foundry":{"releaseCommands":["foundry-release-npm","foundry-release-git"]},"gitHead":"869b9c4686d46f22120720c2e1b1830b50ac85ae","versions":[{"number":"1.0.0","date":"2015-01-27T09:16:51.053Z"},{"number":"1.1.0","date":"2015-01-27T09:41:44.347Z"},{"number":"1.2.0","date":"2015-01-27T09:53:52.028Z"},{"number":"1.3.0","date":"2015-02-09T11:23:24.349Z"},{"number":"1.3.1","date":"2015-02-11T01:42:52.158Z"},{"number":"1.3.2","date":"2015-02-12T08:42:36.219Z"},{"number":"1.3.3","date":"2015-02-12T09:11:57.679Z"},{"number":"1.4.0","date":"2015-02-12T09:15:31.171Z"},{"number":"2.0.0","date":"2015-02-25T06:38:47.011Z"},{"number":"3.0.0","date":"2015-03-06T22:44:55.051Z"},{"number":"3.0.1","date":"2015-03-06T23:24:45.362Z"},{"number":"3.0.2","date":"2016-10-29T00:08:10.876Z"},{"number":"3.0.3","date":"2016-10-29T00:56:53.424Z"}],"readme":"# nine-track [![Build status](https://travis-ci.org/twolfson/nine-track.png?branch=master)](https://travis-ci.org/twolfson/nine-track)\n\nRecord and playback HTTP requests\n\nThis is built to make testing against third party services a breeze. No longer will your test suite fail because an external service is down.\n\n> `nine-track` is inspired by [`cassette`][] and [`vcr`][]. This is a fork of [`eight-track`][] due to permissioning issues.\n\n[`cassette`]: https://github.com/uber/cassette\n[`vcr`]: https://rubygems.org/gems/vcr\n[`eight-track`]: https://github.com/uber/eight-track\n\n## Breaking changes in 3.0.0\nWe found a regression when saving series requests in parallel. To remedy this, we are only using `pastRequestKeys` from the time of the initial request. This means some of your hashes might change for series based requests.\n\n## Getting Started\nInstall the module with: `npm install nine-track`\n\n```js\n// Start up a basic applciation\nvar express = require('express');\nvar nineTrack = require('nine-track');\nvar request = require('request');\nexpress().use(function (req, res) {\n  console.log('Pinged!');\n  res.send('Hello World!');\n}).listen(1337);\n\n// Create a server using a `nine-track` middleware to the original\nexpress().use(nineTrack({\n  url: 'http://localhost:1337',\n  fixtureDir: 'directory/to/save/responses'\n})).listen(1338);\n\n// Hits original server, triggering a `console.log('Pinged!')` and 'Hello World!' response\nrequest('http://localhost:1338/', console.log);\n\n// Hits saved response but still receieves 'Hello World!' response\nrequest('http://localhost:1338/', console.log);\n```\n\n## Documentation\n`nine-track` exposes `nineTrack` as its `module.exports`.\n\n### `nineTrack(options)`\nMiddleware creator for new `nineTrack's`. This *is not* a constructor.\n\n- options `Object` - Container for parameters\n    - url `String|Object` - URL of a server to proxy to\n        - If it is a string, it should be the base URL of a server\n        - If it is an object, it should be parameters for [`url.format`][]\n    - fixtureDir `String` - Path to load/save HTTP responses\n        - Files will be saved with the format `{{method}}_{{encodedUrl}}_{{hashOfRequestContent}}.json`\n        - An example filename is `GET_%2F_658e61f2a6b2f1ae4c127e53f28dfecd.json`\n    - preventRecording `Boolean` - Flag to throw errors if a request has not been recorded previously\n        - By default, this is `false`; no errors will be thrown\n        - This can be useful in CI to reveal missing fixtures\n    - normalizeFn `Function` - Function to adjust `request's` save location signature\n        - If you would like to make two requests resolve from the same response file, this is how.\n        - The function signature should be `function (info)` and can either mutate the `info` or return a fresh object\n        - info `Object` - Container for `request` information\n            - httpVersion `String` - HTTP version received from `request` (e.g. `1.0`, `1.1`)\n            - headers `Object` - Headers received by `request`\n                - An example would be `{\"host\": \"locahost:1337\"}`\n            - trailers `Object` - Trailers received by `request`\n            - method `String` - HTTP method that was used (e.g. `GET`, `POST`)\n            - url `String` - Pathname that `request` arrived from\n                - An example would be `/`\n            - body `Buffer` - Buffered body that was written to `request`\n        - Existing `normalizeFn` libraries (e.g. `multipart/form-data` can be found below)\n    - scrubFn `Function` - Functon to adjust `request's` and `response's` before saving to disk\n        - If you would like to sanitize information from JSON files before saving, this is how.\n        - The function signature should be `function (info)` and can either mutate `info` or return a fresh object\n        - `scrubFn` is run twice: on hash key lookup and when saving to disk. For key lookup, only `info.request` is defined and `info.response` must be checked for before manipulating it\n        - info `Object` - Container for `request` and `response` information\n          - request `Object` - Container for `request` information\n            - Same information as present in `normalizeFn.info`\n          - response `Object` - Container for `response` information\n            - httpVersion `String` - HTTP version received from `response` (e.g. `1.0`, `1.1`)\n            - headers `Object` - Headers received by `response`\n                - An example would be `{\"x-powered-by\": \"Express\"}`\n            - trailers `Object` - Trailers received by `response`\n            - statusCode `Number` - Status code received from response\n                - An example would be `200`\n            - body `Buffer` - Body received from response\n                - If this is adjusted, we will automatically correct the `Content-Length` response header\n\n[`url.format`]: http://nodejs.org/api/url.html#url_url_format_urlobj\n\n`nineTrack` returns a middleware with the signature `function (req, res)`\n\n```js\n// Example of string url\nnineTrack({\n  url: 'http://localhost:1337',\n  fixtureDir: 'directory/to/save/responses'\n});\n\n// Example of object url\nnineTrack({\n  url: {\n    protocol: 'http:',\n    hostname: 'localhost',\n    port: 1337\n  },\n  fixtureDir: 'directory/to/save/responses'\n});\n```\n\nIf you need to buffer the data before passing it off to `nine-track` that is supported as well.\nThe requirement is that you record the data as a `Buffer` or `String` to `req.body`.\n\n#### `normalizeFn` libraries\n- `multipart/form-data` - Ignore randomly generated boundaries and consolidate similar `multipart/form-data` requests\n    - Website: https://github.com/twolfson/nine-track-normalize-multipart\n\n### `nineTrack.forwardRequest(req, cb)`\nForward an incoming HTTP request in a [`mikeal/request`][]-like format.\n\n- req `http.IncomingMessage` - Inbound request to an HTTP server (e.g. from `http.createServer`)\n    - Documentation: http://nodejs.org/api/http.html#http_http_incomingmessage\n- cb `Function` - Callback function with `(err, res, body)` signature\n    - err `Error` - HTTP error if any occurred (e.g. `ECONNREFUSED`)\n    - res `Object` - Container that looks like an HTTP object but simiplified due to saving to disk\n        - httpVersion `String` - HTTP version received from external server response (e.g. `1.0`, `1.1`)\n        - headers `Object` - Headers received by response\n        - trailers `Object` - Trailers received by response\n        - statusCode `Number` - Status code received from external server response\n        - body `Buffer` - Buffered body that was written to response\n    - body `Buffer` - Sugar variable for `res.body`\n\n[`mikeal/request`]: https://github.com/mikeal/request\n\n### `nineTrack.startSeries(key)`\nBegin a series of requests that rely on each other. We will compound past keys onto the hash generated for the current request. This allows for testing items like:\n\n1. Retrieve item, verify non-existence\n2. Create item\n3. Retrieve item, verify existence\n\nNormally, we would be unable to test this since steps (1) and (3) have the same signature. However, by compounding the previous request keys into our key, we can handle this.\n\n**You must remember to run `stopSeries()` at the end of a series. If you do not, it will pollute future requests and make your tests brittle.**\n\n- key `String` - Namespace to use in hashing our requests\n    - This is practical to prevent collisions of similar tests that rely on the same request (e.g. retrieving all resources)\n\n> For your convenience, if a series is corrupted (e.g. a request signature changes), then we will attempt clean up the series and require a re-run of your test suite. We do not try to re-run with saved information since states could be inconsistent.\n\n```js\nvar nineTrackInstance = nineTrack({\n  url: {\n    protocol: 'http:',\n    hostname: 'localhost',\n    port: 1337\n  },\n  fixtureDir: 'directory/to/save/responses'\n});\nnineTrackInstance.startSeries('create-test');\n// Run get, create, get as requests in series\nnineTrackInstance.stopSeries();\n```\n\n### `nineTrack.stopSeries()`\nStop a series of requests. This will remove the chaining effect from `startSeries` and reset `nineTrack` to default behavior.\n\n## Examples\n### Proxy server with subpath\n`nine-track` can talk to servers that are behind a specific path\n\n```js\n// Start up a server that echoes our path\nexpress().use(function (req, res) {\n  res.send(req.path);\n}).listen(1337);\n\n// Create a server using a `nine-track` middleware to the original\nexpress().use(nineTrack({\n  url: 'http://localhost:1337/hello',\n  fixtureDir: 'directory/to/save/responses'\n})).listen(1338);\n\n// Logs `/hello/world`, concatenated result of `/hello` and `/world` pathss\nrequest('http://localhost:1338/world', console.log);\n```\n\n### Normalizing requests\nSometimes requests have unpredictable an header or body (e.g. `timestamp`). We can leverage `normalizeFn` to make our request hashes consistent to force the same look up.\n\n**This does not affect outgoing request data.**\n\n```js\n// Start up a server that echoes our path\nexpress().use(function (req, res) {\n  res.send(req.path);\n}).listen(1337);\n\n// Create a server using a `nine-track` middleware to the original\nexpress().use(nineTrack({\n  url: 'http://localhost:1337',\n  fixtureDir: 'directory/to/save/responses',\n  normalizeFn: function (info) {\n    if (info.headers['X-Timestamp']) {\n      // Normalize all timestamps to a consistent number\n      info.headers['X-Timestamp'] = '2015-02-12T00:00:00.000Z';\n    }\n  }\n})).listen(1338);\n\n// On first run, makes valid request\n// On future runs, repeats same response\nrequest({\n  url: 'http://localhost:1338/world',\n  headers: {\n    'X-Timestamp': (new Date()).toISOString()\n  }\n}, console.log);\n```\n\n### Scrubbing requests\nIn some repositories, there is sensitive data being sent/received in requests/responses that you would like to be sanitized. `scrubFn` takes request/response information and removes it from the saved content and hash.\n\n```js\n// Start up a server that echoes our path\nexpress().use(bodyParser.urlencoded()).use(function (req, res) {\n  res.send(req.body.sensitive_token === 'password');\n}).listen(1337);\n\n// Create a server using a `nine-track` middleware to the original\nexpress().use(nineTrack({\n  url: 'http://localhost:1337',\n  fixtureDir: 'directory/to/save/responses',\n  scrubFn: function (info) {\n    var bodyObj = querystring.parse(info.request.body.toString('utf8'));\n    if (bodyObj.sensitive_token) {\n      // Normalize all sensitive token to a hidden value\n      bodyObj.sensitive_token = '****';\n      info.request.body = querystring.stringify(bodyObj);\n    }\n  }\n})).listen(1338);\n\n// On first run, makes successful request and saves sanitized data\n// On future runs, repeats same response\nrequest({\n  url: 'http://localhost:1338/world',\n  form: {\n    sensitive_token: 'password'\n  }\n}, console.log); // true\n\n// Saved to disk\n/*\n\"request\": {\n  \"body\": \"sensitive_token=****\"\n}\n*/\n```\n\n### Modifying response data\nOccasionally, we want to reply with near accurate data but adjust it slightly (e.g. return an empty list, reproduce an encoding issue). For this example, we will leverage `forwardRequest` to return an adjusted list.\n\n```js\n// Start up a server that echoes our path\nexpress().use(function (req, res) {\n  res.json({items: ['a', 'b', 'c']});\n}).listen(1337);\n\n// Create a server using a `nine-track` middleware to the original\nvar nineTrackFn = nineTrack({\n  url: 'http://localhost:1337',\n  fixtureDir: 'directory/to/save/responses'\n});\nexpress().use(function (localReq, localRes) {\n  nineTrackFn.forwardRequest(localReq, function (err, remoteRes, remoteBody) {\n    // If there was an error, emit it\n    if (err) {\n      return localReq.emit('error', err);\n    }\n\n    // Otherwise, attempt to adjust the body\n    var remoteJson = JSON.parse(remoteBody);\n    if (remoteJson.items.length === 3) {\n      remoteJson.items.pop();\n    }\n\n    // Send our response\n    localRes.json(remoteJson);\n  });\n}).listen(1338);\n\n// On first run, makes successful request and saves sanitized data\n// On future runs, repeats same response\nrequest('http://localhost:1338/world', console.log); // {items: ['a', 'b']}\n\n// Saved on disk\n/*\n\"response\": {\n  \"body\": \"{\\n  \\\"items\\\": [\\n    \\\"a\\\",\\n    \\\"b\\\",\\n    \\\"c\\\"\\n  ]\\n}\"\n}\n*/\n```\n\n### Prevent recording\nIn CI, it can be useful to prevent requests to remote servers since all fixtures should be saved by this point. In this example, we leverage `preventRecording` and the Travis CI environment variable to not allow new requests in Travis CI.\n\n```js\n// Start up a server that echoes our path\nexpress().use(function (req, res) {\n  res.json(req.path);\n}).listen(1337);\n\n// Create a server using a `nine-track` middleware to the original\nexpress().use(nineTrack({\n  url: 'http://localhost:1337',\n  fixtureDir: 'directory/to/save/responses',\n  preventRecording: !!process.env.TRAVIS\n})).listen(1338);\n\nrequest('http://localhost:1338/world', console.log);\n\n// On an unsaved fixture in \"Travis CI\"\n/*\nevents.js:72\n        throw er; // Unhandled 'error' event\n              ^\nError: Fixture not found for request \"{\"httpVersion\":\"1.1\",\"headers\":{\"host\":\"localhost:1338\",\"connection\":\"keep-alive\"},\"trailers\":{},\"method\":\"GET\",\"url\":\"/world\",\"body\":\"\"}\"\n    at createRemoteReq (/home/todd/github/nine-track/lib/nine-track.js:240:21)\n    at fn (/home/todd/github/nine-track/node_modules/async/lib/async.js:582:34)\n    at Object._onImmediate (/home/todd/github/nine-track/node_modules/async/lib/async.js:498:34)\n    at processImmediate [as _immediateCallback] (timers.js:354:15)\n*/\n```\n\n## Contributing\nIn lieu of a formal styleguide, take care to maintain the existing coding style. Add unit tests for any new or changed functionality. Lint via `npm run lint` and test via `npm test`.\n\n## License\nAll work up to and including `87a024b` is owned by Uber under the [MIT license][].\n\n[MIT license]: https://github.com/twolfson/nine-track/blob/87a024ba47584311dc3d5bc10e11682c1fbd7bdf/LICENSE-MIT\n\nAfter that commit, all modifications to the work have been released under the [UNLICENSE][] to the public domain.\n\n[UNLICENSE]: UNLICENSE\n","created":"2015-01-27T09:16:51.053Z","modified":"2016-10-29T00:56:53.424Z","lastPublisher":{"name":"twolfson","email":"todd@twolfson.com"},"owners":[{"name":"twolfson","email":"todd@twolfson.com"}],"other":{"_attachments":{},"_from":".","_id":"nine-track","_nodeVersion":"4.5.0","_npmOperationalInternal":{"host":"packages-12-west.internal.npmjs.com","tmp":"tmp/nine-track-3.0.3.tgz_1477702613183_0.052235870622098446"},"_npmUser":{"name":"twolfson","email":"todd@twolfson.com"},"_npmVersion":"2.15.11","_rev":"3-25c70f4d0aba9c97302952ca93dd782e","_shasum":"36c4e94ba1b00e4eefc58eb496e6048d282e15e3","author":{"name":"Todd Wolfson","email":"todd@twolfson.com","url":"http://twolfson.com/"},"bugs":{"url":"https://github.com/twolfson/nine-track/issues"},"directories":{},"dist-tags":{"latest":"3.0.3"},"dist":{"shasum":"36c4e94ba1b00e4eefc58eb496e6048d282e15e3","tarball":"http://registry.npmjs.org/nine-track/-/nine-track-3.0.3.tgz"},"maintainers":[{"name":"twolfson","email":"todd@twolfson.com"}],"readmeFilename":"README.md","time":{"modified":"2016-10-29T00:56:53.424Z","created":"2015-01-27T09:16:51.053Z","1.0.0":"2015-01-27T09:16:51.053Z","1.1.0":"2015-01-27T09:41:44.347Z","1.2.0":"2015-01-27T09:53:52.028Z","1.3.0":"2015-02-09T11:23:24.349Z","1.3.1":"2015-02-11T01:42:52.158Z","1.3.2":"2015-02-12T08:42:36.219Z","1.3.3":"2015-02-12T09:11:57.679Z","1.4.0":"2015-02-12T09:15:31.171Z","2.0.0":"2015-02-25T06:38:47.011Z","3.0.0":"2015-03-06T22:44:55.051Z","3.0.1":"2015-03-06T23:24:45.362Z","3.0.2":"2016-10-29T00:08:10.876Z","3.0.3":"2016-10-29T00:56:53.424Z"}}}