{"name":"arrjs","description":"HTTP and WebSocket application request routing","version":"0.1.0","dependencies":{"http-proxy":"0.8.0","optimist":"0.3.1","mongodb":"0.9.8","socket.io":"0.8.7"},"devDependencies":{},"homepage":"http://github.com/tjanczuk/arrjs","keywords":["routing","http","application","web"],"repository":"https://github.com/tjanczuk/arrjs","engines":{"node":">= 0.7.0-pre"},"optionalDependencies":{},"_engineSupported":true,"_defaultsLoaded":true,"versions":[{"number":"0.1.0","date":"2012-02-07T18:22:30.790Z"}],"readme":"#HTTP and WebSocket application routing\n===\n\nYou can expose several HTTP or WebSocket applications over a single TCP port using ARR.JS. This is useful for better \nutilization of servers, including shared hosting. \n\n- Host N applications on M servers, each application in K(N) instances, 1 <= K(N) <= M.\n- Routing based on the ```Host``` HTTP request header.\n- HTTP and HTTPS.\n- WebSockets and secure WebSockets.\n- SNI support for SSL.\n- Message-based process activation.\n- Process monitoring and crash recovery. \n- Host applications built with arbitrary technology with its own HTTP stack, including node.js.\n- Works on Windows, MacOS, and *nix. \n- Built with node.js, MongoDB, and nodejitsu HTTP proxy. \n\n## Prerequisities\n\n- Windows, MacOS, or *nix (tested on Windows 7 & 2008 Server, MacOS Lion, Ubuntu 11.10)\n- [node.js v0.7.0 or greater](http://nodejs.org/dist/). MacOS and *nix may use earlier versions.\n- [MongoDB](http://www.mongodb.org/downloads). The database is used to store application metadata and must be \naccessible from all backends. \n\n## Getting started\n\nInstructions below are for setting up a single machine deployment (e.g. development environment) on a MacOS. \nOther OSes are conceptually similar. \n\nStart unsecure MongoDB server on localhost:\n\n```\nmongod\n```\n\nImport application metadata for the three sample applications:\n\n```\nmongoimport -d arr -c apps src/apps.json\n```\n\nConfigure your HOSTS file (/etc/hosts on MacOS and *nix, %systemroot%\\system32\\drivers\\etc\\hosts on Windows) \nto resolve domain names used by the sample applications to localhost by adding the following lines:\n\n```\n127.0.0.1 app1.janczuk.org\n127.0.0.1 app1.tangyorange.com\n127.0.0.1 app2.janczuk.org\n127.0.0.1 app2.tangyorange.com\n127.0.0.1 ws1.janczuk.org\n127.0.0.1 ws1.tangyorange.com\n```\n\nStart the ARR.JS router to listen for unsecured traffic on port 80 and SSL traffic on port 443 \n(these ports cannot be used by other processes on the box):\n\n```\ncd src\nsudo node arr.js --mongo=mongodb://localhost/arr -p 80 -s 443\n```\n\nIssue a few requests to test the system:\n\n```\ncurl http://app1.tangyorange.com\ncurl https://app1.janczuk.org -k\ncurl http://app2.janczuk.org\ncurl https://app2.janczuk.org -k\n```\n\nIn your favorite modern browser navigate to ```http://ws1.janczuk.org```. You should see Dante's Divine Comedy \nstreamed down to the browser over a WebSocket connection, a stanza every 2 seconds. When connecting \nover ```https://ws1.janczuk.org``` you will first see a security warning because the certificate exposed by \nthe application is not trusted (it is self-signed). \n\n## Deployment on a server farm\n\n### Database\n\nThe MongoDB dabatase holds application metadata and must be accessible from all servers in the farm. \nYou can use your own instance or get started with a free instance\nprovided by [MongoHQ](https://mongohq.com/home). Bottom line is you need a \n[MongoDB connection URL](http://www.mongodb.org/display/DOCS/Connections) to provide to \nall instances of arr.js you will run on the backends.\n\nThe application metadata must be stored in a single MongoDB collection called ```apps```. Each document in this collection \nmust have the following structure:\n\n```\n{\n  process: {\n    executable: \"node\",                 // specify the executable name here, including path if needed\n    args: [                             // specify whatever command line arguments must be passed to the executable\n      \"apps/app1/server.js\"\n    ]\n  },\n  hosts: [\n    { \n      host: \"app1.janczuk.org\",\n      ssl: \"allowed\",                       // you must say \"allowed\", \"required\", or \"none\" (for unsecure access only)\n      cert: \"certs/app1-janczuk-cert.pem\",  // optional file with X.509 certificate associated with this host name\n      key: \"certs/app1-key.pem\"             // optional file with the private key for the X.509 certificate\n    },\n    // ... you can specify multiple host names that can be used to access this application\n  ],\n  instances: 2,                             // maximum number of instances of this application to create\n  machines: [                               // this is the array of machines the application is currently running on\n  ]                                         // and it must be set to empty initially; it is managed by arr.js\n}\n```\n\nFor an example of application metadata, check out [apps.json](https://github.com/tjanczuk/arrjs/blob/master/src/apps.json), \na file that can be imported into the MongoDB database using the \n[mongoimport](http://www.mongodb.org/display/DOCS/Import+Export+Tools#ImportExportTools-mongoimport) tool.\n\n### Backends\n\nEach server in the farm dedicated to running applications must be running an instance of arr.js. Typically each of \nthe instances of arr.js would be configured identically, which allows any run of the mill TCP level load balancer\nto be put in front of the server farm. Arr.js accepts the following parameters:\n\n```\nUsage: node ./arr.js\n\nOptions:\n  -m, --mongo    Mongo DB connecton string                      [default: \"mongodb://localhost/arr\"]\n  -r, --range    Managed TCP port range                         [default: \"8000-9000\"]\n  -p, --port     Unsecured listen port                          [default: 31415]\n  -s, --sslport  SSL listen port                                [default: 31416]\n  -c, --cert     Non-SNI (wildcard) server certificate for SSL  [default: \"certs/wildcard-janczuk-cert.pem\"]\n  -k, --key      Private key for SSL                            [default: \"certs/wildcard-janczuk-key.pem\"]\n```\n\nThe [MongoDB connection URL](http://www.mongodb.org/display/DOCS/Connections) (-m) must point to the central MongoDB \ndatabase with the ```apps``` collection that holds the application metadata. \n\nThe managed TCP port range (-r) indicates the range of TCP ports arr.js will use to assign a TCP port to a\nmanaged application when it is activated. The TCP port number assigned to an instance of an application is passed to the \napplication through\nthe process environment variable named ```PORT```. In case of node.js applications for example, this value is accessible \nvia the ```process.env.PORT``` property and can be used to set up an HTTP listener. \nSee [server.js](https://github.com/tjanczuk/arrjs/blob/master/src/apps/app1/server.js) for an example. \n\nThe unsecured (-p) and secured (-s) port number are the two TCP port numbers arr.js will listen on. Arr.js will \naccept HTTP and WS traffic on the unsecured port, and HTTPS and WSS traffic on the secured port. SSL security terminates \nat arr.js. Arr.js acts as an HTTP[S]/WS[S] reverse proxy, routing incoming requests to appropriate applications\nbased on the value of the Host HTTP request header. If necessary, an instance of an application is activated. \nCommunication between arr.js and an instance of an application is not secured with SSL\n(i.e. plaintext HTTP or WS is used), so the application code should always set up their listeners for HTTP and WS, \nregardless whether calls the client issues requests over SSL or not. Appropriate set of ```x-forwarded-*``` HTTP request\nheaders that arr.js adds to the routed requests allow applications to learn more about the original client connection. \n\nEach instance of arr.js is configured with an X.509 certificate (-c) and the associated private key (-k). This\ncertificate and private key are used to identify the server during the SSL handshake, unless application specific\nconfiguration specifies its own certificate and private key to be used  with \n[Server Name Identification (SNI)](http://en.wikipedia.org/wiki/Server_Name_Indication). Note that for SNI to take effect\nthe client must support it (which most modern browsers do). If you plan to support SSL for multiple applications with \ndifferent host names and use a single server side certificate to secure them, the domain suffix of the host name\nof these applications must be the same (e.g. foo.barbaz.com and baz.barbaz.com), and the arr.js certificate must be a \nwildcard certificate (e.g. CN=*.barbaz.com). \n\n### Network Load Balancer\n\nIn a typical deployment servers in a farm would run behind a TCP level load balancer. For the convenience of \ndevelopment, this project includes a very simple, TCP level software load balancer, \n[nlb.js](https://github.com/tjanczuk/arrjs/blob/master/src/nlb.js). \n\nConfiguration of nlb.js is stored in the adjacent ```nlb.json``` file with the following structure:\n\n```\n[\n  {                             // multiple \"routing rules\" are allowed; typically one for unsecure traffic and one for SSL\n\t\t\"port\": 80,                 // the input TCP port number the load balancer will listen on\n\t\t\"backends\": [               // array of arr.js backend endpoints to load balance incoming TCP connections to\n\t\t\t{\n\t\t\t\t\"host\": \"localhost\",    // destination host name\n\t\t\t\t\"port\": 31415           // destination port number (does not need to match the input port number)\n\t\t\t}\n\t\t]\n\t},\n\t{\n\t\t\"port\": 443,\n\t\t\"backends\": [\n\t\t\t{\n\t\t\t\t\"host\": \"localhost\",\n\t\t\t\t\"port\": 31416\n\t\t\t}\n\t\t]\n\t}\n]\n```\n\nThe nlb.js is stared as a simple node application:\n\n```\ncd src\nsudo node nlb.js\n```\n\nThe nlb.js will perform TCP level, round robin load balancing of incoming TCP connections across the specified backends. ","created":"2012-02-07T18:22:29.120Z","modified":"2012-02-07T18:22:30.790Z","lastPublisher":{"name":"tjanczuk","email":"tomasz@janczuk.org"},"owners":[{"name":"tjanczuk","email":"tomasz@janczuk.org"}],"other":{"_attachments":{},"_id":"arrjs","_nodeVersion":"v0.7.2-pre","_npmUser":{"name":"tjanczuk","email":"tomasz@janczuk.org"},"_npmVersion":"1.1.0-2","_rev":"1-5e9d429145fa99f7a06c15933ff6fec2","author":{"name":"Tomasz Janczuk","email":"tomasz@janczuk.org","url":"http://tomasz.janczuk.org"},"bugs":{"url":"http://github.com/tjanczuk/arrjs/issues"},"directories":{},"dist-tags":{"latest":"0.1.0"},"dist":{"shasum":"761678d3702e724bee9596e075e90088598c9f9d","tarball":"http://registry.npmjs.org/arrjs/-/arrjs-0.1.0.tgz"},"maintainers":[{"name":"tjanczuk","email":"tomasz@janczuk.org"}],"time":{"modified":"2012-02-07T18:22:30.790Z","created":"2012-02-07T18:22:29.120Z","0.1.0":"2012-02-07T18:22:30.790Z"}}}