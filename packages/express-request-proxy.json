{"name":"express-request-proxy","version":"2.0.0","description":"Intelligent http proxy Express middleware","main":"index.js","scripts":{"lint":"eslint .","test":"mocha --reporter spec --bail --check-leaks test/","test-cov":"istanbul cover node_modules/mocha/bin/_mocha -- --reporter dot --check-leaks test/","test-travis":"istanbul cover node_modules/mocha/bin/_mocha --report lcovonly -- --reporter spec --check-leaks test/"},"repository":"https://github.com/4front/express-request-proxy","keywords":["4front","express","middleware","request","api","proxy"],"license":"Apache-2.0","homepage":"https://github.com/4front/express-request-proxy","dependencies":{"async":"^1.4.0","body-parser":"^1.12.0","camel-case":"^1.1.1","debug":"^2.1.1","lodash":"^4.6.1","lru-cache":"^4.0.0","path-to-regexp":"^1.1.1","request":"^2.53.0","simple-errors":"^1.0.0","through2":"^2.0.0","type-is":"^1.6.6","url-join":"0.0.1"},"devDependencies":{"compression":"^1.6.0","dash-assert":"^1.0.2","eslint":"^2.3.0","eslint-config-4front":"^1.1.3","express":"^4.11.1","istanbul":"^0.4.2","memory-cache-stream":"^1.0.4","mocha":"^2.4.5","shortid":"^2.1.3","sinon":"^1.15.4","supertest":"^1.0.1"},"gitHead":"f4b0750a46c2659d38d852bf5f04f5961143096f","versions":[{"number":"1.0.0","date":"2015-07-07T18:06:50.386Z"},{"number":"1.0.1","date":"2015-07-14T23:04:49.120Z"},{"number":"1.0.2","date":"2015-07-15T17:10:02.366Z"},{"number":"1.0.3","date":"2015-07-16T04:49:41.574Z"},{"number":"1.0.4","date":"2015-07-19T16:21:43.454Z"},{"number":"1.0.5","date":"2015-07-19T16:37:29.047Z"},{"number":"1.0.6","date":"2015-07-19T16:42:33.265Z"},{"number":"1.0.7","date":"2015-07-31T21:14:19.386Z"},{"number":"1.0.8","date":"2015-11-09T23:47:03.537Z"},{"number":"1.0.9","date":"2015-11-18T17:55:57.260Z"},{"number":"1.0.10","date":"2015-12-08T05:55:02.611Z"},{"number":"1.0.11","date":"2016-01-17T00:52:41.710Z"},{"number":"1.1.0","date":"2016-01-22T03:59:57.984Z"},{"number":"1.2.0","date":"2016-02-25T16:18:59.956Z"},{"number":"2.0.0","date":"2016-03-07T22:15:01.950Z"}],"readme":"# express-request-proxy\n\n[![NPM Version][npm-image]][npm-url]\n[![NPM Downloads][downloads-image]][downloads-url]\n[![Build Status][travis-image]][travis-url]\n[![Test Coverage][coveralls-image]][coveralls-url]\n\nHigh performance streaming http request reverse proxy for [Express](http://expressjs.com) based on the [request http client](https://www.npmjs.com/package/request). Supports caching, custom routes, server-side injection of sensitive keys, authentication, and response transformations.\n\n## Usage\n\n#### Server Code\n~~~js\nvar redis = require('redis');\nvar requestProxy = require('express-request-proxy');\n\nrequire('redis-streams')(redis);\n\napp.get('/api/:resource/:id', requestProxy({\n\tcache: redis.createClient(),\n\tcacheMaxAge: 60,\n\turl: \"https://someapi.com/api/:resource/:id\",\n\tquery: {\n\t  secret_key: process.env.SOMEAPI_SECRET_KEY\n\t},\n\theaders: {\n\t\t'X-Custom-Header': process.env.SOMEAPI_CUSTOM_HEADER\n\t}\n}));\n~~~\n\n#### Client Code\n\n~~~js\n$.ajax({\n\turl: '/api/widgets/' + widgetId,\n\tstatusCode: {\n\t  200: function(data) {\n  \t\tconsole.log(data);\n\t  },\n\t  404: function() {\n\t\tconsole.log(\"cannot find widget\");\n\t  }\n\t}\n});\n~~~\n\n### Options\n__`url`__\n\nString representing the url of the remote endpoint to proxy to. Can contain named route parameters. Query parameters can be appended with the `query` option. This is the only required option.\n\n__`params`__\n\nAn object containing properties to substitute for named route parameters in the remote URL. Named parameters are declared using the same conventions as Express routes, i.e. `/pathname/:param1/:param2`. The path portion of the `url` is parsed using the [path-to-regexp](https://www.npmjs.com/package/path-to-regexp) module. Defaults to `{}`.\n\n__`query`__\n\nAn object of parameters to be appended to the querystring of the specified `url`. This is a good way to append sensitive parameters that are stored as environment variables on the server avoiding the need to expose them to the client. Any parameters specified here will override an identically named parameter in the `url` or on the incoming request to the proxy. Defaults to `{}`.\n\n__`headers`__\n\nAn object of HTTP headers to be appended to the request to the remote url. This is also a good way to inject sensitive keys stored in environment variables. See the [http basic auth](#http-basic-auth) section for example usage.\n\n__`cache`__\n\nCache object that conforms to the [node_redis](https://www.npmjs.com/package/redis) API. Can set to `false` at an endpoint level to explicitly disable caching for certain APIs. See [Cache section](#caching) below for more details.\n\n__`cacheMaxAge`__\n\nThe duration to cache the API response. If an API response is returned from the cache, a `max-age` http header will be included with the remaining TTL.\n\n__`ensureAuthenticated`__\n\nEnsure that there is a valid logged in user in order to invoke the proxy. See the [Ensure Authenticated](#ensure-authenticated) section below for details.\n\n__`userAgent`__\n\nThe user agent string passed as a header in the http call to the remote API. Defaults to `\"express-api-proxy\"`.\n\n__`cacheHttpHeader`__\n\nName of the http header returned in the proxy response with the value `\"hit\"` or `\"miss\"`. Defaults to `\"Express-Request-Proxy-Cache\"`.\n\n\n#### HTTP Basic Auth\nFor http endpoints protected by [HTTP Basic authentication](http://en.wikipedia.org/wiki/Basic_access_authentication#Client_side), a username and password should be sent in the form `username:password`  which is then base64 encoded.\n\n~~~js\nvar usernamePassword = process.env.SOMEAPI_USERNAME + \":\"\n\t+ process.env.SOMEAPI_PASSSWORD;\n\napp.post(\"/api/:resource\", requestProxy({\n\tcache: redis.createClient(),\n\tcacheMaxAge: 60,\n\turl: \"https://someapi.com/api/:resource\",\n\theaders: {\n\t\tAuthorization: \"Basic \" + new Buffer(usernamePassword).toString('base64')\n\t}\n}));\n~~~\n\n\n#### Logged-In User Properties\nSometimes it's necessary to pass attributes of the current logged in user (on the server) into the request to the remote endpoint as headers, query params, etc. Rather than passing environment variables, simply specify the desired user properties.\n\n~~~js\napp.all(\"/api/protected/:resource\", requestProxy({\n  url: \"http://remoteapi.com/api\",\n  query: {\n    access_token: req.user.accessToken\n  }\n}));\n~~~\n\nThis assumes that prior middleware has set the `req.user` property, which was perhaps stored in [session state](https://www.npmjs.com/package/express-session).\n\n\n### Caching\n\nFor remote endpoints whose responses do not change frequently, it is often desirable to cache responses at the proxy level. This avoids repeated network round-trip latency and can skirt rate limits imposed by the API provider.\n\nThe object provided to the `cache` option is expected to implement a subset of the [node_redis](https://github.com/mranney/node_redis) interface, specifically the [get](http://redis.io/commands/get), [set](http://redis.io/commands/set), [setex](http://redis.io/commands/setex), [exists](http://redis.io/commands/exists), [del](http://redis.io/commands/del), and [ttl](http://redis.io/commands/ttl) commands. The node_redis package can be used directly, other cache stores require a wrapper module that adapts to the redis interface.\n\nAs an optimization, two additional functions, `readStream` and `writeThrough` must be implemented on the cache object to allow direct piping of the API responses into and out of the cache. This avoids buffering the entire API response in memory. For node_redis, the [redis-streams](https://www.npmjs.com/package/redis-streams) package augments the `RedisClient` with these two functions. Simply add the following line to your module before the proxy middleware is executed:\n\n```js\nvar redis = require('redis');\n\nrequire('redis-streams')(redis);\n// After line above, calls to redis.createClient will return enhanced\n// object with readStream and writeThrough functions.\n\napp.get('/proxy/:route', requestProxy({\n\tcache: redis.createClient(),\n\tcacheMaxAge: 300, // cache responses for 5 minutes\n\turl: 'https://someapi.com/:route'\n}));\n```\n\nOnly `GET` requests are subject to caching, for all other methods the `cacheMaxAge` is ignored.\n\n#### Caching Headers\nIf an API response is served from the cache, the `max-age` header will be set to the remaining TTL of the cached object. The proxy cache trumps any HTTP headers such as `Last-Modified`, `Expires`, or `ETag`, so these get discarded. Effectively the proxy takes over the caching behavior from the origin for the duration that it exists there.\n\n### Ensure Authenticated\n\nIt's possible restrict proxy calls to authenticated users via the `ensureAuthenticated` option.\n\n~~~js\napp.all('/proxy/protected', requestProxy({\n\turl: 'https://someapi.com/sensitive',\n\tensureAuthenticated: true\n}));\n~~~\n\nThe proxy does not perform authentication itself, that task is delegated to other middleware that executes earlier in the request pipeline which sets the property `req.ext.isAuthenticated`. If `ensureAuthenticated` is `true` and `req.ext.isAuthenticated !== true`, a 401 (Unauthorized) HTTP response is returned before ever executing the remote request.\n\nNote that this is different than authentication that might be enforced by the remote API itself. That's handled by injecting headers or query params as discussed above.\n\n### Wildcard routes\n\nSometimes you want to configure one catch-all proxy route that will forward on all path segments starting from the `*`. The example below will proxy a request to `GET /api/widgets/12345` to `GET https://remoteapi.com/api/v1/widgets/12345` and `POST /api/users` to `POST https://remoteapi.com/api/v1/users`.\n\n~~~js\napp.all('/api/*', requestProxy({\n  url: 'https://remoteapi.com/api/v1/*',\n  query: {\n    apikey: 'xxx'\n  }\n}));\n~~~\n\n### Transforms\n\nThe proxy supports transforming the API response before piping it back to the caller. Transforms are functions which return a Node.js [transform stream](http://nodejs.org/api/stream.html#stream_class_stream_transform). The [through2](https://github.com/rvagg/through2) package provides a lightweight wrapper that makes transforms easier to implement.\n\nHere's a trivial transform function that simply appends some text\n\n~~~js\nmodule.exports = function(options) {\n  return {\n    name: 'appender',\n    transform: function() {\n      return through2(function(chunk, enc, cb) {\n        this.push(chunk);\n        cb();\n      }, function(cb) {\n        this.push(options.appendText);\n        cb();\n      });\n    }\n  };\n}\n~~~\n\nIf the transform needs to change the `Content-Type` of the response, a `contentType` property can be declared on the transform function that the proxy will recognize and set the header accordingly.\n\n~~~js\nmodule.exports = function() {\n  return {\n    name: 'appender',\n    contentType: 'application/json',\n    transform: function() {\n      return through2(...)\n    }\n  };\n}\n~~~\n\nSee the [markdown-transform](https://github.com/4front/markdown-transform) for a real world example. For transforming HTML responses, the [trumpet package](https://www.npmjs.com/package/trumpet), with it's streaming capabilities, is a natural fit.\n\nHere's how you could request a GitHub README.md as html:\n\n~~~js\nvar markdownTransform = require('markdown-transform');\n\napp.get('/:repoOwner/:repoName/readme', requestProxy({\n  url: 'https://raw.githubusercontent.com/:repoOwner/:repoName/master/README.md',\n  transforms: [markdownTransform({highlight: true})]\n}));\n~~~\n\n\n## License\nLicensed under the [Apache License, Version 2.0](http://www.apache.org/licenses/LICENSE-2.0).\n\n[npm-image]: https://img.shields.io/npm/v/express-request-proxy.svg?style=flat\n[npm-url]: https://npmjs.org/package/express-request-proxy\n[travis-image]: https://img.shields.io/travis/4front/express-request-proxy.svg?style=flat\n[travis-url]: https://travis-ci.org/4front/express-request-proxy\n[coveralls-image]: https://img.shields.io/coveralls/4front/express-request-proxy.svg?style=flat\n[coveralls-url]: https://coveralls.io/r/4front/express-request-proxy?branch=master\n[downloads-image]: https://img.shields.io/npm/dm/express-request-proxy.svg?style=flat\n[downloads-url]: https://npmjs.org/package/express-request-proxy\n","starsCount":8,"created":"2015-07-07T18:06:50.386Z","modified":"2017-05-13T14:46:02.736Z","lastPublisher":{"name":"dvonlehman","email":"david.vonlehman@gmail.com"},"owners":[{"name":"dvonlehman","email":"david.vonlehman@gmail.com"}],"other":{"_attachments":{},"_from":".","_id":"express-request-proxy","_nodeVersion":"5.7.0","_npmOperationalInternal":{"host":"packages-13-west.internal.npmjs.com","tmp":"tmp/express-request-proxy-2.0.0.tgz_1457388899494_0.6089758093003184"},"_npmUser":{"name":"dvonlehman","email":"david.vonlehman@gmail.com"},"_npmVersion":"3.6.0","_rev":"6-fc65ed29cc3e48c617e9a8e5877f5a8f","_shasum":"01919aec61e89a0f824fa5e6e733b8e063c9d64d","author":{"name":"David Von Lehman","url":"https://github.com/dvonlehman"},"bugs":{"url":"https://github.com/4front/express-request-proxy/issues"},"directories":{},"dist-tags":{"latest":"2.0.0"},"dist":{"shasum":"01919aec61e89a0f824fa5e6e733b8e063c9d64d","tarball":"http://registry.npmjs.org/express-request-proxy/-/express-request-proxy-2.0.0.tgz"},"maintainers":[{"name":"dvonlehman","email":"david.vonlehman@gmail.com"}],"readmeFilename":"README.md","time":{"modified":"2017-05-13T14:46:02.736Z","created":"2015-07-07T18:06:50.386Z","1.0.0":"2015-07-07T18:06:50.386Z","1.0.1":"2015-07-14T23:04:49.120Z","1.0.2":"2015-07-15T17:10:02.366Z","1.0.3":"2015-07-16T04:49:41.574Z","1.0.4":"2015-07-19T16:21:43.454Z","1.0.5":"2015-07-19T16:37:29.047Z","1.0.6":"2015-07-19T16:42:33.265Z","1.0.7":"2015-07-31T21:14:19.386Z","1.0.8":"2015-11-09T23:47:03.537Z","1.0.9":"2015-11-18T17:55:57.260Z","1.0.10":"2015-12-08T05:55:02.611Z","1.0.11":"2016-01-17T00:52:41.710Z","1.1.0":"2016-01-22T03:59:57.984Z","1.2.0":"2016-02-25T16:18:59.956Z","2.0.0":"2016-03-07T22:15:01.950Z"},"users":{"ivanoats":true,"hugojosefson":true,"itskdk":true,"dzhou777":true,"shakakira":true,"arielfr":true,"danbluefoot":true,"marcosc90":true}}}